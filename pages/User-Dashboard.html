<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SafeBite - User Dashboard</title>
  <link rel="stylesheet" href="../assets/css/User-assets/sidebar.css">
    <link rel="stylesheet" href="../assets/css/User-assets/dashboard.css">
    <script src="../assets/js/config/quiet-console.js"></script>
    <script src="../assets/js/config/error-handler.js"></script>
    <script src="../assets/js/config/api-config.js"></script>
  <link rel="stylesheet" href="../assets/css/User-assets/analyticstat.css">
  <link rel="stylesheet" href="../assets/css/User-assets/ad-chart.css">
  <link rel="stylesheet" href="../assets/css/User-assets/spoilageReport.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <link rel="stylesheet" href="../assets/css/User-assets/responsive-overrides.css">
  <link rel="stylesheet" href="../assets/css/User-assets/report-generator.css">
  <link rel="stylesheet" href="../assets/css/User-assets/analysis.css">
  <link rel="stylesheet" href="../assets/css/User-assets/smart-training.css">
  <link rel="stylesheet" href="../assets/css/User-assets/user-log.css">
  <link rel="stylesheet" href="../assets/css/User-assets/config.css">
  <link rel="stylesheet" href="../assets/css/User-assets/feedback.css">
  <link rel="stylesheet" href="../assets/css/User-assets/dashboard-inline-styles.css">
  <link rel="stylesheet" href="../assets/css/User-assets/modal-styles.css">
  <!-- <link rel="stylesheet" href="../assets/css/User-assets/alerts.css"> -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>
<body>
<!-- Hamburger Menu Button -->
<button id="hamburger-menu" class="hamburger-menu" aria-label="Toggle navigation">
  <i class="bi bi-list"></i>
</button>

<!-- Sidebar Overlay -->
<div id="sidebar-overlay" class="sidebar-overlay"></div>

<aside class="sidebar expanded" id="sidebar">
  <div class="sidebar-header">
    <span class="sidebar-logo" id="sidebarLogo">S</span>
    <span class="sidebar-title user-name"></span>
  </div>
  <nav class="sidebar-nav">
    <!-- Main Navigation -->
      <ul>
      <li class="nav-item active">
        <a href="#" class="nav-link" data-page="dashboard">
          <i class="bi bi-house-door nav-icon"></i>
          <span class="nav-text">Dashboard</span>
        </a>
      </li>
    </ul>
      

    <!-- Reports & Analysis Section -->
    <div class="nav-section">
      <div class="nav-section-title">Reports & Analysis</div>
      <ul>
      <li class="nav-item is-truncated">
        <a href="#" class="nav-link" data-page="spoilage-report">
          <i class="bi bi-graph-up nav-icon"></i>
          <span class="nav-text">Spoilage Reports</span>
        </a>
      </li>
      <li class="nav-item is-truncated">
        <a href="#" class="nav-link" data-page="report-generator">
          <i class="bi bi-file-earmark-text nav-icon"></i>
          <span class="nav-text">Reports Generator</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" data-page="analysis">
          <i class="bi bi-search nav-icon"></i>
          <span class="nav-text">Analysis</span>
        </a>
      </li>
    </ul>
    </div>

    <!-- Account & Support Section -->
    <div class="nav-section">
      <div class="nav-section-title">Account & Support</div>
      <ul>
      <li class="nav-item is-truncated">
        <a href="#" class="nav-link" data-page="user-logs">
          <i class="bi bi-key nav-icon"></i>
          <span class="nav-text">User Logs / History</span>
        </a>
      </li>
      <li class="nav-item is-truncated">
        <a href="#" class="nav-link" data-page="feedbacks">
          <i class="bi bi-chat-dots nav-icon"></i>
            <span class="nav-text">Feedbacks / Support</span>
        </a>
      </li>
  </ul>
    </div>
</nav>
  <div class="sidebar-account" id="sidebarAccount">
    <i class="bi bi-person-circle account-icon"></i>
    <span class="account-text" id="accountText">Profile</span>
    <button class="logout-btn" id="logoutBtn">Logout</button>
  </div>
</aside>
<main id="main-content">
  <!-- Content will be loaded here by spa.js -->
</main>



<!--Dashboard-->
<template id="dashboard-template">
    <div class="dashboard-container container-fluid">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
        </div>
        
        <!-- Navigation Tabs -->
        <div class="dashboard-tabs">
          <button class="dashboard-tab active" data-tab="dashboard">Dashboard</button>
          <button class="dashboard-tab" data-tab="food-selection">Smart Training</button>
          <button class="dashboard-tab" data-tab="devices">Devices</button>
        </div>
        
        <!-- Dashboard Content -->
        <div id="dashboard-content" class="dashboard-content">
          <!-- Top Row: Sensor Cards -->
          <div class="dashboard-row row mb-4">
            <div class="dashboard-card sensors-card col-12">
              <div class="sensors-header">
                <div class="sensors-header-left">
                  <div class="sensors-header-icon">
                    <i class="bi bi-activity"></i>
                  </div>
                  <div class="sensors-header-content">
                    <h4>Real-time Sensor Readings</h4>
                    <p class="sensors-header-subtitle">Live monitoring of your food safety sensors</p>
                  </div>
                </div>
                <div class="sensors-header-right">
                  <div class="sensors-status-indicator">
                    <div class="status-dot online"></div>
                    <span class="status-text">All Systems Active</span>
                  </div>
                </div>
              </div>
              <div class="sensor-cards-container row gx-3 gy-3 mt-4">
                <!-- JS will render sensor cards here -->
              </div>
              <!-- Generalized Quick Scanner -->
              <div class="generalized-scanner-section mt-4">
                <div class="scanner-button-card generalized-scanner-card">
                  <div class="scanner-button-content">
                    <div class="scanner-icon" style="background: rgba(46, 213, 115, 0.1);">
                      <i class="bi bi-lightning-charge-fill" style="color: #2ed573;"></i>
                    </div>
                    <div class="scanner-text">
                      <h5>Quick Scanner</h5>
                      <p>Instantly analyze any food using current sensor readings</p>
                    </div>
                    <button id="quickScanBtn" class="btn btn-success scanner-open-btn">
                      <i class="bi bi-lightning-charge"></i>
                      Quick Scan
                    </button>
                  </div>
                </div>
              </div>
              <!-- ML Food Scanner Button -->
              <div class="ml-scanner-button-section mt-4">
                <div class="scanner-button-card">
                  <div class="scanner-button-content">
                    <div class="scanner-icon">
                      <i class="bi bi-cpu"></i>
                    </div>
                    <div class="scanner-text">
                      <h5>SmartSense Scanner</h5>
                      <p>Select food and scan with sensors for AI-powered prediction</p>
                    </div>
                    <button id="openMLScannerBtn" class="btn btn-primary scanner-open-btn">
                      <i class="bi bi-scan"></i>
                      Start Scan
                    </button>
                  </div>
                </div>
              </div>
              <div class="sensors-footer">
                <div class="sensors-summary">
                  <div class="summary-item">
                    <span class="summary-label">Total Sensors</span>
                    <span class="summary-value" id="totalSensors">0</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Active</span>
                    <span class="summary-value active" id="activeSensors">0</span>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Last Update</span>
                    <span class="summary-value" id="lastUpdate">Just now</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Middle Row: Latest Scan Result and Alerts -->
          <div class="dashboard-row row mb-4">
            <div class="dashboard-card latest-scan-card col-12 col-lg-6 mb-3">
              <div class="scan-card-header">
                <div class="scan-card-icon">
                  <i class="bi bi-clipboard-data"></i>
                </div>
                <div class="scan-card-title">
                  <h4>Latest Scan Result</h4>
                  <p>Most recent food analysis</p>
                </div>
                <div class="scan-card-controls">
                  <button id="refreshLatestScan" class="btn-refresh-scan" title="Refresh Latest Scan">
                    <i class="fas fa-sync-alt"></i>
                  </button>
                  <div class="realtime-indicator">
                    <i class="fas fa-circle text-success"></i>
                    <span>Live</span>
                  </div>
                </div>
              </div>
              <div class="scan-card-content" id="latestScanContent">
                <div class="scan-result-card">
                  <!-- Dynamic content will be loaded here -->
                </div>
              </div>
            </div>
            <div class="dashboard-card alerts-card col-12 col-lg-6 mb-3">
              <h4>Device Alerts</h4>
              <div id="alerts-container" class="alerts-container">
                <!-- Dynamic alerts will be loaded here by JavaScript -->
              </div>
            </div>
          </div>

          <!-- Bottom Row: Device Activity -->
          <div class="dashboard-row row">
            <div class="dashboard-card activity-card col-12">
            <div class="activity-header d-flex justify-content-between align-items-center">
              <span class="activity-title">Device Activity</span>
              <div class="d-flex gap-2">
                <select class="activity-filter form-select form-select-sm w-auto">
                  <option value="monthly" selected>Monthly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>
            </div>
            <div class="activity-counters d-flex flex-wrap gap-2 mb-2">
              <div class="badge rounded-pill" id="count-today">Today: 0</div>
              <div class="badge rounded-pill" id="count-7d">Last 7d: 0</div>
              <div class="badge rounded-pill" id="count-30d">Last 30d: 0</div>
            </div>
              <div class="activity-chart-container">
                <canvas id="activityChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Smart Training Content -->
        <div id="food-selection-content" class="dashboard-content hidden">
          <div class="food-selection-layout">
            <!-- Smart Training Card -->
            <div class="food-selection-container">
              <div class="food-selection-card">
                <div class="food-selection-header">
                  <h2>üß† Smart Training Center</h2>
                  <p>Create food items, scan with sensors, then teach our AI</p>
                </div>
                <div class="food-selection-body">
                  <div class="food-selection-icon">
                    <i class="bi bi-lightbulb"></i>
                  </div>
                  <h3>Start Smart Training</h3>
                  <p>Create a food item, scan it with your sensors, then share the results to train our AI</p>
                  <button class="food-selection-btn" id="selectFoodBtn">
                    <i class="bi bi-plus-circle"></i>
                    Create & Scan Food
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Smart Training History Section -->
            <div class="food-history-container">
              <div class="food-history-card">
                <div class="food-history-header">
                  <h3>üìö Your Smart Training History</h3>
                  <p>Track your food scanning and AI training sessions</p>
                </div>
                <div class="food-history-content">
                  <div class="food-history-filters">
                    <select id="historyFilter" class="history-filter">
                      <option value="all">All Foods</option>
                      <option value="today">Today</option>
                      <option value="week">This Week</option>
                      <option value="month">This Month</option>
                    </select>
                    <button id="clearFoodHistoryBtn" class="history-clear-btn">
                      <i class="bi bi-trash"></i>
                      Clear history
                    </button>
                  </div>
                  <div class="food-history-list" id="foodHistoryList">
                    <!-- Food scanning history will be rendered here by JavaScript -->
                    <div class="no-history">
                      <i class="bi bi-lightbulb"></i>
                      <p>No smart training sessions yet</p>
                      <span>Start by creating and scanning a food item above</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- User Confirm Modal (for clearing history etc.) -->
            <div id="userConfirmModal" class="modal" style="display:none;">
              <div class="modal-content" style="max-width:460px;">
                <div class="modal-header" style="padding: 20px 24px; background: linear-gradient(135deg, #1a2340 0%, #14224a 100%); border-radius: 8px 8px 0 0;">
                  <div class="modal-title" style="display:flex;align-items:center;gap:10px;">
                    <i class="bi bi-exclamation-triangle" style="color:#ffc107;"></i>
                    <h3 id="userConfirmTitle" style="margin:0;">Confirm</h3>
                  </div>
                  <button type="button" class="modal-close" aria-label="Close" onclick="(function(){document.getElementById('userConfirmModal').style.display='none';})();">&times;</button>
                </div>
                <div class="modal-body" style="padding:24px;">
                  <p id="userConfirmMessage" style="margin:0;">Are you sure?</p>
                </div>
                <div class="modal-footer" style="display:flex;justify-content:flex-end;gap:10px;padding: 16px 24px 24px;">
                  <button id="userConfirmNo" class="btn btn-secondary">No</button>
                  <button id="userConfirmYes" class="btn btn-primary">Yes</button>
                </div>
              </div>
            </div>
          </div>
        </div>


        <!-- Devices Content -->
        <div id="devices-content" class="dashboard-content hidden">
          <div class="devices-layout">
            <!-- Device Information Section -->
            <div class="connect-device-container">
              <div class="connect-device-card">
                <div class="connect-device-header">
                  <i class="bi bi-info-circle"></i>
                  <h3>Device Information</h3>
                </div>
                <div class="connect-device-form">
                  <div class="device-info-text">
                    <p><strong>All devices are automatically connected when registered by the admin.</strong></p>
                    <p>Your sensors are ready to use and will appear in the status list below once they start sending data.</p>
                  </div>
                  <div class="device-info-actions">
                    <button class="refresh-device-btn" id="refreshDevicesBtn">
                      <i class="bi bi-arrow-clockwise"></i>
                      Refresh Device List
                    </button>
                    <button class="view-device-btn" id="viewAllDevicesBtn">
                      <i class="bi bi-info-circle"></i>
                      Device Overview
                  </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Sensor Status Section -->
            <div class="device-status-container">
              <div class="device-status-card">
                <div class="device-status-header">
                  <i class="bi bi-battery-charging"></i>
                  <h3>Sensor Status</h3>
                </div>
                <div class="device-status-list" id="deviceSensorList">
                  <!-- Sensor status items will be rendered here by JavaScript -->
                  <div class="no-devices">
                    <i class="bi bi-battery"></i>
                    <p>No devices connected</p>
                    <span>Connect a device to get started</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
</template>


<!--spoilage-report-->
<template id="spoilage-report-template">
  <div class="spoilage-main">
    <div class="spoilage-header-top">
      <div>
        <h1>Food Spoilage Report System</h1>
        <div class="spoilage-subtitle">Monitor and track food spoilage in real-time</div>
      </div>
      <div class="spoilage-header-buttons">
        <a href="#" class="spoilage-btn active" data-page="spoilage-report">Dashboard</a>
        <a href="#" class="spoilage-btn" data-page="detailed-report">Detailed Report</a>
      </div>
    </div>
    <div class="spoilage-stats-row">
      <div class="spoilage-stat-card"><div class="stat-icon stat-blue bi bi-graph-up-arrow"></div><div class="stat-label">Total Items</div><div class="stat-value">0</div></div>
      <div class="spoilage-stat-card"><div class="stat-icon stat-green bi bi-check-circle"></div><div class="stat-label">Safe</div><div class="stat-value">0</div></div>
      <div class="spoilage-stat-card"><div class="stat-icon stat-yellow bi bi-exclamation-triangle"></div><div class="stat-label">At Risk</div><div class="stat-value">0</div></div>
      <div class="spoilage-stat-card"><div class="stat-icon stat-red bi bi-x-circle"></div><div class="stat-label">Spoiled</div><div class="stat-value">0</div></div>
      <div class="spoilage-stat-card"><div class="stat-icon stat-gray bi bi-info-circle"></div><div class="stat-label">Expired</div><div class="stat-value">0</div></div>
    </div>
    <div class="spoilage-main-cards">
      <div class="spoilage-card spoilage-bar-card">
        <div class="spoilage-card-title">Spoilage Rate by Food Type</div>
        <div class="spoilage-bar-list">
          <!-- Dynamic spoilage bars will be loaded here by JavaScript -->
          <div class="loading-bars">
            <div class="loading-text">Loading spoilage data...</div>
          </div>
        </div>
      </div>
      <div class="spoilage-card spoilage-summary-card">
        <div class="spoilage-card-title">Top Spoiled Foods Summary</div>
        <div class="spoilage-summary-list">
          <!-- Dynamic summary rows will be loaded here by JavaScript -->
          <div class="loading-summary">
            <div class="loading-text">Loading summary data...</div>
          </div>
        </div>
        <div class="summary-total">Total Overview: <span class="summary-total-right">Loading...</span></div>
      </div>
    </div>
  </div>
</template>

<!-- Dashboard Add Food Modal -->
<div class="config-modal" id="dashboardAddFoodModal">
  <div class="config-modal-backdrop"></div>
  <div class="config-modal-content">
    <div class="config-modal-header">
      <span class="config-modal-title">Add Food</span>
      <button class="config-modal-close" aria-label="Close">&times;</button>
    </div>
    <form class="config-modal-form" id="dashboardAddFoodForm">
      <div class="config-modal-row">
        <div class="config-modal-group">
          <label>Food Name *</label>
          <input type="text" id="dashboardFoodName" required placeholder="e.g., Mango, Chicken" />
        </div>
        <div class="config-modal-group">
          <label>Category</label>
          <select id="dashboardFoodCategory" aria-label="Food Category"></select>
        </div>
      </div>
      <div class="config-modal-footer">
        <button type="button" class="config-modal-cancel">Cancel</button>
        <button type="submit" class="config-modal-submit">Add</button>
      </div>
    </form>
  </div>
 </div>

<!-- Dashboard Add Device Modal -->
<div class="config-modal" id="dashboardAddDeviceModal">
  <div class="config-modal-backdrop"></div>
  <div class="config-modal-content">
    <div class="config-modal-header">
      <span class="config-modal-title">Connect Device</span>
      <button class="config-modal-close" aria-label="Close">&times;</button>
    </div>
    <form class="config-modal-form" id="dashboardAddDeviceForm">
      <div class="config-modal-row">
        <div class="config-modal-group">
          <label>Sensor ID *</label>
          <input type="text" id="dashboardDeviceId" required placeholder="e.g., SENSOR_001, TEMP_01" />
        </div>
        <div class="config-modal-group">
          <label>Sensor Type *</label>
          <select id="dashboardDeviceType" aria-label="Sensor Type">
            <option value="Temperature">Temperature</option>
            <option value="Humidity">Humidity</option>
            <option value="Gas">Gas</option>
          </select>
        </div>
      </div>
      <div class="config-modal-footer">
        <button type="button" class="config-modal-cancel">Cancel</button>
        <button type="submit" class="config-modal-submit">Connect</button>
      </div>
    </form>
  </div>
</div>

<!-- ML Food Scanner Modal -->
<div class="config-modal" id="mlFoodScannerModal">
  <div class="config-modal-backdrop"></div>
  <div class="config-modal-content ml-scanner-modal">
    <div class="config-modal-header">
      <span class="config-modal-title">
        <i class="bi bi-cpu"></i> SmartSense Scanner
      </span>
      <button class="config-modal-close" aria-label="Close">&times;</button>
    </div>
    <div class="ml-scanner-body">
      <div class="ml-scanner-description">
        <p>
          Select a food item and scan with sensors for AI-powered spoilage prediction
        </p>
      </div>
      
      <div class="ml-scanner-controls">
        <div class="ml-scanner-row">
          <div class="ml-scanner-group">
            <div class="ml-scanner-group-header">
              <label for="mlFoodSelect">
                Choose from existing foods
              </label>
              <button type="button" id="refreshFoodListBtn" class="btn btn-sm refresh-food-list-btn">
                <i class="bi bi-arrow-clockwise"></i> Refresh
              </button>
            </div>
            <select id="mlFoodSelect" class="form-select mlFoodSelect">
              <option value="">Select from available foods</option>
            </select>
            <div class="sensor-info">
              <i class="bi bi-info-circle"></i> Will wait for new sensor data before running AI prediction
            </div>
          </div>
        </div>
        
        <!-- Sensor Data Waiting Indicator -->
        <div id="sensorDataWaitIndicator" class="sensor-wait-indicator">
          <div class="waiting-content">
            <div class="spinner-border spinner-border-sm text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <span class="waiting-text">Waiting for new sensor data...</span>
          </div>
          <div class="waiting-progress">
            <div class="progress">
              <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-label="Loading progress"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="ml-scanner-footer">
        <button type="button" class="config-modal-cancel">
          Cancel
        </button>
        <button type="button" id="readyScanBtn" class="config-modal-submit">
          <i class="bi bi-scan"></i> Start Scanning
        </button>
      </div>
    </div>
  </div>
</div>

<!-- AI Prediction Results Modal -->
<div class="config-modal" id="mlPredictionResultsModal" style="display:none;">
  <div class="config-modal-backdrop"></div>
  <div class="config-modal-content ml-results-modal" style="background:#212c4d;color:#e0e6f6;border:1px solid #2b3a66;max-width:500px;">
    <div class="config-modal-header" style="border-bottom:1px solid #1B5886;">
      <span class="config-modal-title" style="color:#fff;">
        <i class="bi bi-check-circle-fill" style="color:#3776A1;"></i> AI Prediction Complete!
      </span>
      <button class="config-modal-close" aria-label="Close" style="color:#bfc9da;">&times;</button>
    </div>
    <div class="ml-results-body" style="padding:20px;">
      <div class="ml-results-content">
        <div class="ml-results-item">
          <span class="ml-results-label">Food:</span>
          <span class="ml-results-value" id="mlResultFood">-</span>
        </div>
        <div class="ml-results-item">
          <span class="ml-results-label">Status:</span>
          <span class="ml-results-value" id="mlResultStatus">-</span>
        </div>
        <div class="ml-results-item">
          <span class="ml-results-label">Confidence:</span>
          <span class="ml-results-value" id="mlResultConfidence">-</span>
        </div>
        <div class="ml-results-recommendation">
          <span class="ml-results-label">Recommendation:</span>
          <p class="ml-results-recommendation-text" id="mlResultRecommendation">-</p>
        </div>
      </div>
    </div>
      <div class="ml-results-footer" style="border-top:1px solid #1B5886;padding:16px 20px;display:flex;justify-content:flex-end;">
      <button type="button" id="mlResultsOkBtn" class="config-modal-submit" style="background:#3776A1;color:#fff;border:none;padding:8px 20px;border-radius:6px;">
        OK
      </button>
    </div>
  </div>
</div>

<!-- Food Recommendations Detail Modal -->
<div class="config-modal" id="foodRecommendationsModal" style="display:none;">
  <div class="config-modal-backdrop"></div>
  <div class="config-modal-content" style="background:#212c4d;color:#e0e6f6;border:1px solid #2b3a66;max-width:600px;">
    <div class="config-modal-header" style="border-bottom:1px solid #1B5886;">
      <span class="config-modal-title" style="color:#fff;">
        <i class="bi bi-clipboard-data" style="color:#4a9eff;"></i> Food Analysis Details
      </span>
      <button class="config-modal-close" aria-label="Close" style="color:#bfc9da;">&times;</button>
    </div>
    <div class="recommendations-body" style="padding:20px;">
      <div class="food-detail-header">
        <div class="food-detail-info">
          <h3 id="detailFoodName" style="color:#fff;margin:0 0 8px 0;">Fresh Salmon</h3>
          <div class="food-detail-meta">
            <span class="detail-category" id="detailCategory">Seafood</span>
            <span class="detail-created" id="detailCreated">Created: 12/25/2024</span>
          </div>
        </div>
        <div class="food-detail-status">
          <span class="detail-status-badge" id="detailStatusBadge">Safe</span>
          <div class="detail-risk-score" id="detailRiskScore">Risk: 15%</div>
        </div>
      </div>
      
      <div class="recommendations-content">
        <div class="recommendations-section">
          <h4 style="color:#fff;margin:0 0 12px 0;display:flex;align-items:center;gap:8px;">
            <i class="bi bi-lightbulb" style="color:#f59e0b;"></i>
            Detailed Recommendations
          </h4>
          <div class="recommendations-list" id="recommendationsList">
            <div class="recommendation-item">
              <div class="recommendation-icon"><i class="bi bi-thermometer"></i></div>
              <div class="recommendation-content">
                <div class="recommendation-title">Temperature Control</div>
                <div class="recommendation-text">Maintain storage temperature between 0-4¬∞C to prevent bacterial growth and maintain freshness.</div>
              </div>
            </div>
            <div class="recommendation-item">
              <div class="recommendation-icon"><i class="bi bi-clock"></i></div>
              <div class="recommendation-content">
                <div class="recommendation-title">Consumption Timeline</div>
                <div class="recommendation-text">Consume within 3 days for optimal quality and safety. Monitor for any changes in appearance or smell.</div>
              </div>
            </div>
            <div class="recommendation-item">
              <div class="recommendation-icon"><i class="bi bi-droplet"></i></div>
              <div class="recommendation-content">
                <div class="recommendation-title">Humidity Management</div>
                <div class="recommendation-text">Current humidity levels are optimal. Avoid exposure to direct moisture to prevent spoilage.</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="sensor-details-section">
          <h4 style="color:#fff;margin:20px 0 12px 0;display:flex;align-items:center;gap:8px;">
            <i class="bi bi-activity" style="color:#4a9eff;"></i>
            Sensor Readings
          </h4>
          <div class="sensor-details-grid" id="sensorDetailsGrid">
            <div class="sensor-detail-item">
              <div class="sensor-detail-label">Temperature</div>
              <div class="sensor-detail-value">2.1¬∞C</div>
              <div class="sensor-detail-status good">Optimal</div>
            </div>
            <div class="sensor-detail-item">
              <div class="sensor-detail-label">Humidity</div>
              <div class="sensor-detail-value">65%</div>
              <div class="sensor-detail-status good">Good</div>
            </div>
            <div class="sensor-detail-item">
              <div class="sensor-detail-label">Gas Level</div>
              <div class="sensor-detail-value">12 ppm</div>
              <div class="sensor-detail-status good">Normal</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="recommendations-footer" style="border-top:1px solid #2b3a66;padding:16px 20px;display:flex;justify-content:flex-end;">
      <button type="button" id="recommendationsCloseBtn" class="config-modal-submit" style="background:#4a9eff;color:#fff;border:none;padding:8px 20px;border-radius:6px;">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Modal System Styles -->

<!-- Global Modal System -->
<div class="modal-system" id="globalModal">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">
        <span class="modal-icon"><i class="bi bi-info-circle"></i></span>
        <span class="modal-title-text">Information</span>
      </h3>
      <button class="modal-close" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <p class="modal-message">Modal message will appear here</p>
    </div>
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary modal-btn-cancel">Cancel</button>
      <button class="modal-btn modal-btn-primary modal-btn-confirm">OK</button>
    </div>
  </div>
</div>

<!-- Edit Account Modal -->
<div class="config-modal" id="editAccountModal">
  <div class="config-modal-backdrop"></div>
  <div class="config-modal-content edit-account-modal">
    <div class="config-modal-header">
      <button class="config-modal-close" aria-label="Close">&times;</button>
      <div class="edit-account-avatar" id="editAccountAvatar">
        ML
      </div>
      <span class="config-modal-title">Edit Account</span>
    </div>
    
    <form class="config-modal-form" id="editAccountForm">
      <!-- Personal Information -->
      <div class="edit-account-section">
        <div class="config-modal-row">
          <div class="config-modal-group">
            <label>
              <i class="bi bi-person"></i>
              First Name
            </label>
            <input type="text" id="editFirstName" required placeholder="Enter first name" />
          </div>
          <div class="config-modal-group">
            <label>
              <i class="bi bi-person"></i>
              Last Name
            </label>
            <input type="text" id="editLastName" required placeholder="Enter last name" />
          </div>
        </div>
        
        <div class="config-modal-row">
          <div class="config-modal-group">
            <label>
              <i class="bi bi-at"></i>
              Username
            </label>
            <input type="text" id="editUsername" required placeholder="Enter username" />
          </div>
        </div>
        
        <div class="config-modal-row">
          <div class="config-modal-group">
            <label>
              <i class="bi bi-envelope"></i>
              Email
            </label>
            <input type="email" id="editEmail" required placeholder="Enter email address" />
          </div>
        </div>
        
        <!-- Tester Type -->
        <div class="config-modal-row">
          <div class="config-modal-group">
            <label>
              <i class="bi bi-person-badge"></i>
              Tester Type
            </label>
            <div id="editTesterTypeDisplay">
              <span id="editTesterTypeText">Loading...</span>
            </div>
          </div>
        </div>
        
        <div class="config-modal-row">
          <div class="config-modal-group">
            <label>
              <i class="bi bi-telephone"></i>
              Contact Number
            </label>
            <input type="tel" id="editContactNumber" required placeholder="Enter Philippine mobile number (e.g., 09123456789)" />
          </div>
        </div>
      </div>
      
      <!-- Password Section -->
      <div class="edit-account-divider">
        <h3>Change Password</h3>
        
        <div class="config-modal-row">
          <div class="config-modal-group">
            <label>
              <i class="bi bi-lock"></i>
              New Password
            </label>
            <div>
              <input type="password" id="editNewPassword" placeholder="Enter new password" />
              <button type="button" class="password-toggle" onclick="togglePasswordVisibility('editNewPassword')">
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </div>
        </div>
        
        <div class="config-modal-row">
          <div class="config-modal-group">
            <label>
              <i class="bi bi-lock-fill"></i>
              Re-enter Password
            </label>
            <div>
              <input type="password" id="editReenterPassword" placeholder="Re-enter new password" />
              <button type="button" class="password-toggle" onclick="togglePasswordVisibility('editReenterPassword')">
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </form>
    
    <div class="config-modal-footer">
      <button type="button" class="config-modal-cancel">
        Cancel
      </button>
      <button type="submit" form="editAccountForm" class="config-modal-submit">
        <i class="bi bi-floppy"></i>
        Save
      </button>
    </div>
  </div>
</div>

<!-- Food Selection Modal -->
<div class="food-selection-modal" id="foodSelectionModal">
  <div class="food-selection-modal-backdrop"></div>
  <div class="food-selection-modal-content">
    <div class="food-selection-modal-header">
      <button class="food-selection-modal-close" aria-label="Close">&times;</button>
      <div class="food-selection-modal-icon">
        <i class="bi bi-egg-fried"></i>
      </div>
      <h2>Smart Training - Teach the AI</h2>
      <p>Scan your food and our sensors will automatically assess its condition</p>
    </div>
    
    <div class="food-selection-modal-body">
      <div class="food-selection-divider">
        <span>Add your food for scanning</span>
      </div>
      
      <div class="food-selection-section">
        <h3>Add Custom Food</h3>
        <div class="food-selection-form">
          <div class="food-selection-form-group">
            <label>Food Name</label>
            <input type="text" id="customFoodName" placeholder="Enter food name" />
          </div>
          <div class="food-selection-form-group">
            <label>Category</label>
            <select id="customFoodCategory" aria-label="Food Category">
              <option value="">Select category</option>
              <option value="Fruits">Fruits</option>
              <option value="Vegetables">Vegetables</option>
              <option value="Meat">Meat</option>
              <option value="Seafood">Seafood</option>
              <option value="Dairy">Dairy</option>
              <option value="Grains">Grains</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    
    <div class="food-selection-modal-footer">
      <button class="food-selection-cancel-btn" id="cancelFoodSelection">Cancel</button>
      <button class="food-selection-confirm-btn" id="confirmFoodSelection">
        <i class="bi bi-robot"></i>
        Teach the AI
      </button>
    </div>
  </div>
</div>

<!-- Food Selected Confirmation with Smart Training -->
<div class="food-selected-confirmation" id="foodSelectedConfirmation">
  <div class="food-selected-card" id="food-selected-card">
    <button type="button" class="modal-close" id="closeFoodSelected" aria-label="Close"
      onclick="document.getElementById('foodSelectedConfirmation').style.display='none'">&times;</button>
    <h2>üß† Smart Training Ready</h2>
    <div class="food-selected-info">
      <p id="selectedFoodInfo">Salmon Fillet from Seafood category ready</p>
      <p>Scan with your IoT device, then teach our AI!</p>
      
      
      <div id="sensorWaitIndicator" class="sensor-wait">
        <span class="sensor-wait-spinner" aria-hidden="true"></span>
        <span class="sensor-wait-text">Waiting for new sensor data...</span>
      </div>
      
      <!-- Auto Training Status -->
      <div id="autoTrainingStatus" class="auto-training-status">
        <div class="training-status-header">
          <h3>üß† AI Training Complete!</h3>
          <p>Your sensor data has been automatically used to train our AI</p>
        </div>
        <div class="training-status-info">
          <div class="status-item" id="trainingStep1">
            <div class="status-icon">
              <i class="bi bi-activity"></i>
            </div>
            <span>Sensor data collected</span>
          </div>
          <div class="status-item" id="trainingStep2">
            <div class="status-icon">
              <i class="bi bi-robot"></i>
          </div>
            <span> No Data Found</span>
          </div>
          <div class="status-item" id="trainingStep3">
            <div class="status-icon">
              <i class="bi bi-database"></i>
            </div>
            <span>ML training data uploaded to database</span>
          </div>
          <div class="status-item" id="trainingStep4">
            <div class="status-icon">
            <i class="bi bi-check-circle"></i>
          </div>
            <span>Prediction: safe</span>
        </div>
          <div class="status-item" id="trainingStep5">
            <div class="status-icon">
              <i class="bi bi-percent"></i>
      </div>
            <span>Confidence: 55%</span>
    </div>
          <div class="status-item" id="trainingStep6">
            <div class="status-icon">
              <i class="bi bi-lightbulb"></i>
            </div>
            <span>AI Insight: AI analysis completed</span>
          </div>
        </div>
      </div>
    </div>
    <button class="food-selected-ok-btn" id="okFoodSelected" style="display:block;">OK</button>
  </div>
</div>

<template id="detailed-report-template">
  <div class="spoilage-main">
    <div class="spoilage-header-top">
      <div>
        <h1>Food Spoilage Report System</h1>
        <div class="spoilage-subtitle">Monitor and track food spoilage in real-time</div>
      </div>
      <div class="spoilage-header-buttons">
        <a href="#" class="spoilage-btn" data-page="spoilage-report">Dashboard</a>
        <a href="#" class="spoilage-btn active" data-page="detailed-report">Detailed Report</a>
      </div>
    </div>
    <div class="detailed-report-card">
      <div class="detailed-report-filters">
        <div class="report-controls">
          <div class="report-control-group">
            <label for="food-category">Food Category</label>
            <select id="food-category" name="food-category" class="report-select">
              <option value="all">All Categories</option>
            </select>
          </div>
          <div class="report-control-group">
            <label for="date-range">Date Range</label>
            <select id="date-range" name="date-range" class="report-select">
              <option value="daily" selected>Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
              <option value="yearly">Yearly</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div class="report-control-group" id="week-picker-group" style="display:none;min-width:200px;">
            <label for="week-picker">Select Week</label>
            <input type="week" id="week-picker" class="report-date-input" />
          </div>
          <div class="report-control-group" id="month-picker-group" style="display:none;min-width:200px;">
            <label for="month-picker">Select Month</label>
            <input type="month" id="month-picker" class="report-date-input" />
          </div>
          <div class="report-control-group" id="year-picker-group" style="display:none;min-width:160px;">
            <label for="year-picker">Select Year</label>
            <input type="number" id="year-picker" min="1970" max="2100" step="1" placeholder="2025" class="report-date-input" />
          </div>
          <div class="report-control-group">
            <label for="records-per-page">Records per Page</label>
            <select id="records-per-page" name="records-per-page" class="report-select">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
          <div class="report-control-group" id="custom-date-range-group" style="display:none;">
            <label for="start-date">Start Date</label>
            <input type="date" id="start-date" name="start-date" class="report-date-input" />
          </div>
          <div class="report-control-group" id="custom-date-range-group-end" style="display:none;">
            <label for="end-date">End Date</label>
            <input type="date" id="end-date" name="end-date" class="report-date-input" />
          </div>
          <div class="report-actions">
            <button class="report-btn report-btn-primary" id="apply-filters">
              <span><i class="bi bi-gear"></i></span>
              Apply Filters
            </button>
            <button class="report-btn report-btn-secondary" id="export-csv">
              <span><i class="bi bi-download"></i></span>
              Download Excel
            </button>
            <button class="report-btn report-btn-secondary" id="export-pdf">
              <span><i class="bi bi-file-text"></i></span>
              Download PDF
            </button>
          </div>
        </div>
      </div>
             <div class="detailed-report-table-card">
         <div class="detailed-report-title">Detailed Spoilage Report</div>
         <table class="detailed-report-table">
          <thead>
            <tr>
              <th>FOOD ITEM</th>
              <th>CATEGORY</th>
              <th>STATUS</th>
              <th>RISK SCORE</th>
              <th>EXPIRY</th>
              <th>SENSORS</th>
              <th>RECOMMENDATIONS</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="7" style="padding: 0;">
                <div class="no-data-state">
                  <div class="no-data-icon">‚è≥</div>
                  <div class="no-data-title">Loading Spoilage Data...</div>
                  <div class="no-data-description">Please wait while we fetch your food spoilage analytics</div>
                </div>
              </td>
            </tr>
          </tbody>
         </table>
       </div>
       
       <!-- Pagination Container -->
       <div id="detailedReportPagination" class="pagination-container" style="display:none;">
         <!-- Pagination will be rendered here by JavaScript -->
       </div>
     </div>
   </div>
 </template>

<template id="config-template">
  <div class="config-main">
    <div class="config-container">
      <h1>Food & Sensor Configuration</h1>
      <div class="config-subtitle">Monitor and manage your food storage with smart sensors</div>
      <div class="config-cards-row">
        <div class="config-card good">
          <div class="config-card-label">Good Items</div>
          <div class="config-card-value">0</div>
          <div class="config-card-icon">&#129482;</div>
        </div>
        <div class="config-card risk">
          <div class="config-card-label">At Risk</div>
          <div class="config-card-value">0</div>
          <div class="config-card-icon">&#9888;</div>
        </div>
        <div class="config-card critical">
          <div class="config-card-label">Critical Items</div>
          <div class="config-card-value">0</div>
          <div class="config-card-icon">&#9888;</div>
        </div>
        <div class="config-card online">
          <div class="config-card-label">Sensors Online</div>
          <div class="config-card-value">0/0</div>
          <div class="config-card-icon">&#128246;</div>
        </div>
      </div>
      <div class="config-content">
        <h2>Food Items Monitoring</h2>
        <div class="config-empty">
          <div class="config-empty-icon">&#129482;</div>
          <div class="config-empty-title">No food items configured yet</div>
          <div class="config-empty-desc">Add your first food item to start monitoring</div>
          <button class="config-add-btn">+ Add Food Item</button>
        </div>
      </div>
      <!-- Add Food Item Modal -->
      <div class="config-modal" id="addFoodItemModal">
        <div class="config-modal-backdrop"></div>
        <div class="config-modal-content" style="background:#003A6B;color:#e0e6f6;border:1px solid #1B5886;">
          <div class="config-modal-header" style="border-bottom:1px solid #1B5886;">
            <span class="config-modal-title" style="color:#fff;">Add New Food Item</span>
            <button class="config-modal-close" aria-label="Close" style="color:#bfc9da;">&times;</button>
          </div>
          <form class="config-modal-form">
            <div class="config-modal-row">
              <div class="config-modal-group">
                <label style="color:#e0e6f6;">Food Name *</label>
                <input type="text" required placeholder="e.g., Adobo, Chicken Curry" style="background:#2a3658;border:1px solid #3a4a6b;color:#fff;">
              </div>
              <div class="config-modal-group">
                <label style="color:#e0e6f6;">Min Temperature (¬∞C) *</label>
                <input type="number" required style="background:#2a3658;border:1px solid #3a4a6b;color:#fff;">
              </div>
              <div class="config-modal-group">
                <label style="color:#e0e6f6;">Max Temperature (¬∞C) *</label>
                <input type="number" required style="background:#2a3658;border:1px solid #3a4a6b;color:#fff;">
              </div>
            </div>
            <div class="config-modal-row">
              <div class="config-modal-group">
                <label style="color:#e0e6f6;">Min Humidity (%)</label>
                <input type="number" style="background:#2a3658;border:1px solid #3a4a6b;color:#fff;">
              </div>
              <div class="config-modal-group">
                <label style="color:#e0e6f6;">Max Humidity (%)</label>
                <input type="number" style="background:#2a3658;border:1px solid #3a4a6b;color:#fff;">
              </div>
              <div class="config-modal-group">
                <label style="color:#e0e6f6;">Min Methane Gas (ppm)</label>
                <input type="number" style="background:#2a3658;border:1px solid #3a4a6b;color:#fff;">
              </div>
              <div class="config-modal-group">
                <label style="color:#e0e6f6;">Max Methane Gas (ppm)</label>
                <input type="number" style="background:#2a3658;border:1px solid #3a4a6b;color:#fff;">
              </div>
            </div>
            <div class="config-modal-group">
              <label style="color:#e0e6f6;">Expiration Date *</label>
              <input type="date" required style="background:#2a3658;border:1px solid #3a4a6b;color:#fff;">
            </div>
            <div class="config-modal-group">
              <label style="color:#e0e6f6;">Initial Status</label>
              <select style="background:#2a3658;border:1px solid #3a4a6b;color:#fff;">
                <option>Good</option>
                <option>At Risk</option>
                <option>Critical</option>
              </select>
            </div>
            <div class="config-modal-footer" style="border-top:1px solid #1B5886;">
              <button type="button" class="config-modal-cancel" style="background:#1B5886;color:#e0e6f6;border:1px solid #3776A1;">Cancel</button>
              <button type="submit" class="config-modal-submit" style="background:#4a9eff;">Add Food Item</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</template>

<!-- Report Generator Template -->
<template id="report-generator-template">
  <div class="report-generator-main">
    <div class="report-generator-header">
      <h1 class="report-generator-title">Report Generator</h1>
      <p class="report-generator-subtitle">Select a report type and date range to generate and download data.</p>
    </div>
      
      <div class="report-generator-card">
        <div class="report-controls">
          <div class="report-control-group">
            <label for="reportType">Report Type</label>
            <select id="userReportType" class="report-select">
              <option value="user-activity">User Activity</option>
              <option value="food-spoilage">Food Spoilage</option>
              <option value="alert-summary">Alert Summary</option>
            </select>
          </div>
          
          <div class="report-control-group">
            <label for="dateRange">Date Range</label>
            <select id="userDateRange" class="report-select">
              <option value="daily" selected>Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
              <option value="yearly">Yearly</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          
          <div class="report-control-group" id="weekPickerGroup" style="display:none;">
            <label for="weekPicker">Select Week</label>
            <input type="week" id="weekPicker" class="report-date-input" />
          </div>
          
          <div class="report-control-group" id="monthPickerGroup" style="display:none;">
            <label for="monthPicker">Select Month</label>
            <input type="month" id="monthPicker" class="report-date-input" />
          </div>
          
          <div class="report-control-group" id="yearPickerGroup" style="display:none;">
            <label for="yearPicker">Select Year</label>
            <input type="number" id="yearPicker" class="report-date-input" min="1970" max="2100" step="1" placeholder="2025" />
          </div>
          
          <div id="customDateRangeGroup" style="display:none;">
            <div class="report-control-group">
              <label for="startDate">Start Date</label>
              <input type="date" id="startDate" class="report-date-input" />
            </div>
            <div class="report-control-group">
              <label for="endDate">End Date</label>
              <input type="date" id="endDate" class="report-date-input" />
            </div>
          </div>
          
          <div class="report-control-group" id="recordsPerPageGroup" style="display:none;">
            <label for="recordsPerPage">Records per Page</label>
            <select id="recordsPerPage" class="report-select">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
          
          <div class="report-actions">
            <button id="userGenerateReport" class="report-btn report-btn-primary">
              <span><i class="bi bi-bar-chart"></i></span>
              Generate Report
            </button>
            <button id="downloadExcel" class="report-btn report-btn-secondary">
              <span><i class="bi bi-download"></i></span>
              Download Excel
            </button>
            <button id="downloadPDF" class="report-btn report-btn-secondary">
              <span><i class="bi bi-file-text"></i></span>
              Download PDF
            </button>
          </div>
        </div>
        
        <div class="report-preview">
          <h2 id="reportTitle" class="report-preview-title">Reports</h2>
          <div class="report-table-container">
            <table class="report-table">
              <thead>
                <tr>
                  <th>ACTIVITY TYPE</th>
                  <th>TIMESTAMP</th>
                  <th>DESCRIPTION</th>
                  <th>SESSION DURATION</th>
                  <th>IP ADDRESS</th>
                </tr>
              </thead>
              <tbody id="userReportTableBody">
                <tr>
                  <td colspan="5" class="empty-state">
                    <div class="empty-state-content">
                      <div class="empty-state-icon"><i class="bi bi-bar-chart"></i></div>
                      <div class="empty-state-title">No Report Generated</div>
                      <div class="empty-state-desc">Select your report type and date range, then click "Generate Report" to view data.</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Pagination Container -->
          <div id="reportPagination" class="pagination-container" style="display:none;">
            <!-- Pagination will be rendered here by JavaScript -->
          </div>
        </div>
      </div>
  </div>
</template>

<!-- Analysis Page Template -->
<template id="analysis-template">
  <div class="analysis-main">
    <div class="analysis-header">
      <div class="analysis-header-left">
        <h1 class="analysis-title">Spoilage Monitoring System</h1>
        <div class="analysis-subtitle">AI-Powered Food Safety Analysis</div>
      </div>
      <div class="analysis-header-right">
        <div class="analysis-nav">
          <button class="analysis-nav-btn active" data-tab="analyze">Analyze</button>
          <button class="analysis-nav-btn" data-tab="ai-chat">AI Chat</button>
        </div>
      </div>
    </div>
    <div class="analysis-content-row">
      <div id="analysisTabContent">
        <div class="analysis-content-row">
          <div class="analysis-card analysis-input-card">
            <div class="analysis-card-title">Sensor Data Input</div>
            <div class="analysis-form-row">
              <div class="analysis-form-group">
                <label>Food Type</label>
                <select id="analysisProductType" class="analysis-input">
                  <option>General</option>
                  <option>Meat</option>
                  <option>Dairy</option>
                  <option>Vegetable</option>
                  <option>Seafood</option>
                </select>
                <div id="analysisCategoryInfo" style="margin-top:6px;color:#9fb8ff;font-size:0.95rem;">Category: ‚Äî</div>
              </div>
            </div>
            <div class="analysis-form-row">
              <div class="analysis-form-group">
                <label><span class="label-icon"><i class="bi bi-thermometer"></i></span><span class="label-text">Temperature (¬∞C)</span></label>
                <input type="number" id="analysisTemp" class="analysis-input" placeholder="e.g. 25.5" />
              </div>
              <div class="analysis-form-group">
                <label><span class="label-icon"><i class="bi bi-droplet"></i></span><span class="label-text">Humidity (%)</span></label>
                <input type="number" id="analysisHumidity" class="analysis-input" placeholder="e.g. 65.2" />
              </div>
              <div class="analysis-form-group">
                <label><span class="label-icon"><i class="bi bi-flask"></i></span><span class="label-text">Gas Level</span></label>
                <input type="number" id="analysisGas" class="analysis-input" placeholder="e.g. 123.4" />
              </div>
            </div>
            <button class="analysis-btn" id="analyzeBtn"><i class="bi bi-search"></i> Analyze Spoilage Risk</button>
          </div>
          <div class="analysis-card analysis-results-card">
            <div class="analysis-card-title">Analysis Results</div>
            <div class="analysis-results-empty" id="analysisResultsEmpty">
              <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f52c.svg" alt="Microscope" style="width:48px;opacity:0.7;" />
              <div>Enter sensor data and click "Analyze" to see results</div>
            </div>
            <div class="analysis-results-output" id="analysisResultsOutput" style="display:none;"></div>
          </div>
        </div>
      </div>
      <div id="aiChatTabContent" style="display:none;width:100%;">
        <div class="analysis-content-row" style="justify-content:center;">
          <div class="ai-chat-card">
            <div class="ai-chat-title">AI Spoilage Expert Chat</div>
            <div class="ai-chat-area">
              <div class="ai-chat-empty">
                <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f916.svg" alt="AI Bot" style="width:48px;opacity:0.7;" />
                <div style="margin-top:8px;font-weight:500;">Start a conversation about spoilage analysis!</div>
                <div style="font-size:0.98rem;color:#888;margin-top:2px;">Try asking: "What temperature is safe for dairy products?"</div>
              </div>
            </div>
            <form class="ai-chat-input-row" autocomplete="off">
              <input class="ai-chat-input" type="text" placeholder="Ask about spoilage analysis, food safety, or sensor data..." />
              <button class="ai-chat-send-btn" type="submit">Send</button>
            </form>
            <div class="ai-chat-tip"><i class="bi bi-lightning"></i> The AI has context of your current sensor data when you chat</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<template id="user-log-template">
  <div class="user-log-main">
    <div class="user-log-header">
      <h1>User Logs/History</h1>
      <div class="user-log-subtitle">View all actions performed by users in the system with date range filtering</div>
    </div>
    <div class="user-log-card">
      <div class="user-log-filters">
        <div class="report-controls">
          <div class="report-control-group">
            <label for="userLogActivityType">Activity Type</label>
            <select id="userLogActivityType" class="report-select">
              <option value="all">All Activities</option>
              <option value="update">Update</option>
              <option value="login">Login</option>
              <option value="logout">Logout</option>
            </select>
          </div>
          <div class="report-control-group">
            <label for="userLogDateRange">Date Range</label>
            <select id="userLogDateRange" class="report-select">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
              <option value="yearly">Yearly</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div class="report-control-group" id="userLogWeekPickerGroup" style="display:none;min-width:200px;">
            <label for="userLogWeekPicker">Select Week</label>
            <input type="week" id="userLogWeekPicker" class="report-date-input" />
          </div>
          <div class="report-control-group" id="userLogMonthPickerGroup" style="display:none;min-width:200px;">
            <label for="userLogMonthPicker">Select Month</label>
            <input type="month" id="userLogMonthPicker" class="report-date-input" />
          </div>
          <div class="report-control-group" id="userLogYearPickerGroup" style="display:none;min-width:160px;">
            <label for="userLogYearPicker">Select Year</label>
            <input type="number" id="userLogYearPicker" min="1970" max="2100" step="1" placeholder="2025" class="report-date-input" />
          </div>
          <div class="report-control-group" id="userLogCustomDateGroup" style="display: none;">
            <label for="userLogStartDate">Start Date</label>
            <input type="date" id="userLogStartDate" class="report-date-input" />
          </div>
          <div class="report-control-group" id="userLogCustomEndDateGroup" style="display: none;">
            <label for="userLogEndDate">End Date</label>
            <input type="date" id="userLogEndDate" class="report-date-input" />
          </div>
          <div class="report-control-group">
            <label for="userLogRecordsPerPage">Records per Page</label>
            <select id="userLogRecordsPerPage" class="report-select" onchange="changeRecordsPerPage(this.value)">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
          </div>
          <div class="report-actions">
            <button id="userLogFilterBtn" class="report-btn report-btn-primary">
              <span>üîÑ</span>
              Apply Filters
            </button>
            <button id="userLogDownloadExcel" class="report-btn report-btn-secondary">
              <span><i class="bi bi-download"></i></span>
              Download Excel
            </button>
            <button id="userLogDownloadPDF" class="report-btn report-btn-secondary">
              <span><i class="bi bi-file-text"></i></span>
              Download PDF
            </button>
          </div>
        </div>
      </div>
      <div class="user-log-table-card">
        <div class="user-log-table-title">
          <span class="table-icon"><i class="bi bi-clipboard"></i></span>
          User Activity Log
        </div>
        <table class="user-log-table">
          <thead>
            <tr>
              <th>USER</th>
              <th>ACTIVITY</th>
              <th>DATE/TIME</th>
              <th>DETAILS</th>
            </tr>
          </thead>
          <tbody id="userLogTableBody">
            <!-- JS will render rows here -->
          </tbody>
        </table>
        <div id="userLogPagination" class="user-log-pagination">
          <!-- JS will render pagination here -->
        </div>
      </div>
    </div>
  </div>
</template>

<!-- Feedback Center Template -->
<template id="feedback-template">
  <div class="feedback-main">
    <div class="feedback-header">
      <h1 class="feedback-title">Feedback Center</h1>
      <div class="feedback-subtitle">Submit feedback and track your history</div>
    </div>
    
    <div class="feedback-stats-row">
      <div class="feedback-stat-card">
        <div class="stat-icon stat-blue"><i class="bi bi-chat"></i></div>
        <div class="stat-label">Total Feedback</div>
        <div class="stat-value" id="totalFeedback">0</div>
      </div>
      <div class="feedback-stat-card">
        <div class="stat-icon stat-orange"><i class="bi bi-clock"></i></div>
        <div class="stat-label">Active Issues</div>
        <div class="stat-value" id="activeIssues">0</div>
      </div>
      <div class="feedback-stat-card">
        <div class="stat-icon stat-green"><i class="bi bi-check"></i></div>
        <div class="stat-label">Resolved</div>
        <div class="stat-value" id="resolvedIssues">0</div>
      </div>
      <div class="feedback-stat-card">
        <div class="stat-icon stat-yellow"><i class="bi bi-star"></i></div>
        <div class="stat-label">Average Rating</div>
        <div class="stat-value" id="averageRating">0.0</div>
      </div>
    </div>
    
    <div class="feedback-content-row">
      <div class="feedback-main-panel">
        <div class="feedback-tabs">
          <button class="feedback-tab active" data-tab="submit">
            <span class="tab-icon">+</span>
            Submit Feedback
          </button>
          <button class="feedback-tab" data-tab="history">
            <span class="tab-icon"><i class="bi bi-chat"></i></span>
            Feedback History
          </button>
        </div>
        
        <!-- Submit Feedback Tab Content -->
        <div id="submitTabContent" class="feedback-tab-content active">
          <form class="feedback-form" id="feedbackForm">
            <div class="feedback-form-row">
              <div class="feedback-form-group">
                <label for="feedbackName">Name *</label>
                <input type="text" id="feedbackName" name="name" required placeholder="Your full name">
              </div>
              <div class="feedback-form-group">
                <label for="feedbackEmail">Email</label>
                <input type="email" id="feedbackEmail" name="email" placeholder="your.email@example.com">
              </div>
            </div>
            
            <div class="feedback-form-row">
              <div class="feedback-form-group">
                <label for="feedbackType">Feedback Type</label>
                <select id="feedbackType" name="type" required>
                  <option value="">Select type...</option>
                  <option value="General Feedback">General Feedback</option>
                  <option value="Device Issue">Device Issue</option>
                  <option value="System Bug">System Bug</option>
                  <option value="Sensor Problem">Sensor Problem</option>
                  <option value="App Crash">App Crash</option>
                  <option value="Performance Issue">Performance Issue</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="feedback-form-group">
                <label for="feedbackPriority">Priority</label>
                <select id="feedbackPriority" name="priority" required>
                  <option value="">Select priority...</option>
                  <option value="Low">Low</option>
                  <option value="Medium">Medium</option>
                  <option value="High">High</option>
                  <option value="Critical">Critical</option>
                </select>
              </div>
            </div>
            
            <div class="feedback-form-group">
              <label>Star Rating</label>
              <div class="rating-input">
                <input type="radio" name="rating" value="1" id="rating1">
                <label for="rating1"><i class="bi bi-star"></i></label>
                <input type="radio" name="rating" value="2" id="rating2">
                <label for="rating2"><i class="bi bi-star"></i></label>
                <input type="radio" name="rating" value="3" id="rating3">
                <label for="rating3"><i class="bi bi-star"></i></label>
                <input type="radio" name="rating" value="4" id="rating4">
                <label for="rating4"><i class="bi bi-star"></i></label>
                <input type="radio" name="rating" value="5" id="rating5">
                <label for="rating5"><i class="bi bi-star"></i></label>
              </div>
            </div>
            
            <div class="feedback-form-group">
              <label for="feedbackDescription">Feedback *</label>
              <textarea id="feedbackDescription" name="description" rows="6" required placeholder="Please describe your feedback in detail..."></textarea>
            </div>
            
            <button type="submit" class="feedback-submit-btn">
              Submit Feedback
            </button>
          </form>
        </div>
        
        <!-- Feedback History Tab Content -->
        <div id="historyTabContent" class="feedback-tab-content">
          <div class="feedback-controls">
          <div class="feedback-search">
            <input type="text" id="feedbackSearch" placeholder="Search feedback..." class="feedback-search-input">
            <span class="search-icon"><i class="bi bi-search"></i></span>
          </div>
          
          <div class="feedback-filters">
            <select id="feedbackTypeFilter" class="feedback-filter">
              <option value="">Type</option>
              <option value="General Feedback">General Feedback</option>
              <option value="Device Issue">Device Issue</option>
              <option value="System Bug">System Bug</option>
              <option value="Sensor Problem">Sensor Problem</option>
              <option value="App Crash">App Crash</option>
              <option value="Performance Issue">Performance Issue</option>
              <option value="Other">Other</option>
            </select>
            
            <select id="feedbackPriorityFilter" class="feedback-filter">
              <option value="">Priority</option>
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
              <option value="Critical">Critical</option>
            </select>
            
            <select id="feedbackStatusFilter" class="feedback-filter">
              <option value="">Status</option>
              <option value="Active">Active</option>
              <option value="Resolved">Resolved</option>
              <option value="Archived">Archived</option>
            </select>
            
            <select id="feedbackRecordsPerPage" class="feedback-filter">
              <option value="6" selected>6 per page</option>
              <option value="10">10 per page</option>
              <option value="25">25 per page</option>
              <option value="50">50 per page</option>
            </select>
          </div>
          
          <div class="feedback-view-toggle">
            <button class="view-toggle-btn" data-view="cards">Cards</button>
            <button class="view-toggle-btn active" data-view="table">Table</button>
            <button id="clearFiltersBtn" class="clear-filters-btn">Clear Filters</button>
          </div>
        </div>
        
        <!-- Cards View Container -->
        <div id="feedbackCardsContainer" class="feedback-cards-container" style="display: none;">
          <div class="feedback-cards-grid" id="feedbackCardsGrid">
            <!-- Cards will be rendered here by JavaScript -->
          </div>
          
          <!-- Cards Pagination Container -->
          <div id="feedbackCardsPagination" class="pagination-container" style="display:none;">
            <!-- Pagination will be rendered here by JavaScript -->
          </div>
        </div>
        
        <!-- Table View Container -->
        <div id="feedbackTableContainer" class="feedback-table-container">
          <table class="feedback-table">
            <thead>
              <tr>
                <th>Customer</th>
                <th>Type</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Rating</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="feedbackTableBody">
              <tr>
                <td>
                  <div class="customer-info">
                    <div class="customer-name">sda</div>
                    <div class="customer-desc">sad</div>
                  </div>
                </td>
                <td><span class="type-badge">General Feedback</span></td>
                <td><span class="priority-badge priority-low">Low</span></td>
                <td><span class="status-badge status-active"><i class="bi bi-clock"></i> Active</span></td>
                <td>
                  <div class="rating-stars">
                    <span class="star filled"><i class="bi bi-star-fill"></i></span>
                    <span class="star filled"><i class="bi bi-star-fill"></i></span>
                    <span class="star filled"><i class="bi bi-star-fill"></i></span>
                    <span class="star filled"><i class="bi bi-star-fill"></i></span>
                    <span class="star"><i class="bi bi-star"></i></span>
                  </div>
                </td>
                <td>9/5/2025</td>
                <td><button class="action-btn">View</button></td>
              </tr>
              <tr>
                <td>
                  <div class="customer-info">
                    <div class="customer-name">Test User UI</div>
                    <div class="customer-desc">This is a test feedback submission from the UI...</div>
                  </div>
                </td>
                <td><span class="type-badge">General Feedback</span></td>
                <td><span class="priority-badge priority-low">Low</span></td>
                <td><span class="status-badge status-active"><i class="bi bi-clock"></i> Active</span></td>
                <td>
                  <div class="rating-stars">
                    <span class="star filled"><i class="bi bi-star-fill"></i></span>
                    <span class="star filled"><i class="bi bi-star-fill"></i></span>
                    <span class="star filled"><i class="bi bi-star-fill"></i></span>
                    <span class="star"><i class="bi bi-star"></i></span>
                    <span class="star"><i class="bi bi-star"></i></span>
                  </div>
                </td>
                <td>9/5/2025</td>
                <td><button class="action-btn">View</button></td>
              </tr>
              <tr>
                <td>
                  <div class="customer-info">
                    <div class="customer-name">Bob Johnson</div>
                    <div class="customer-desc">The page loads slowly, especially during peak...</div>
                  </div>
                </td>
                <td><span class="type-badge">Performance Issue</span></td>
                <td><span class="priority-badge priority-medium">Medium</span></td>
                <td><span class="status-badge status-active"><i class="bi bi-clock"></i> Active</span></td>
                <td>
                  <div class="rating-stars">
                    <span class="star filled"><i class="bi bi-star-fill"></i></span>
                    <span class="star filled"><i class="bi bi-star-fill"></i></span>
                    <span class="star filled"><i class="bi bi-star-fill"></i></span>
                    <span class="star"><i class="bi bi-star"></i></span>
                    <span class="star"><i class="bi bi-star"></i></span>
                  </div>
                </td>
                <td>9/5/2025</td>
                <td><button class="action-btn">View</button></td>
              </tr>
              <tr>
                <td>
                  <div class="customer-info">
                    <div class="customer-name">Jane Smith</div>
                    <div class="customer-desc">The application crashes when I try to submit a...</div>
                  </div>
                </td>
                <td><span class="type-badge">System Bug</span></td>
                <td><span class="priority-badge priority-high">High</span></td>
                <td><span class="status-badge status-active"><i class="bi bi-clock"></i> Active</span></td>
                <td>
                  <div class="rating-stars">
                    <span class="star filled"><i class="bi bi-star-fill"></i></span>
                    <span class="star filled"><i class="bi bi-star-fill"></i></span>
                    <span class="star"><i class="bi bi-star"></i></span>
                    <span class="star"><i class="bi bi-star"></i></span>
                    <span class="star"><i class="bi bi-star"></i></span>
                  </div>
                </td>
                <td>9/5/2025</td>
                <td><button class="action-btn">View</button></td>
              </tr>
              <tr>
                <td>
                  <div class="customer-info">
                    <div class="customer-name">John Doe</div>
                    <div class="customer-desc">Great service overall, very satisfied with the e...</div>
                  </div>
                </td>
                <td><span class="type-badge">General Feedback</span></td>
                <td><span class="priority-badge priority-low">Low</span></td>
                <td><span class="status-badge status-resolved"><i class="bi bi-check"></i> Resolved</span></td>
                <td>
                  <div class="rating-stars">
                    <span class="star filled"><i class="bi bi-star-fill"></i></span>
                    <span class="star filled"><i class="bi bi-star-fill"></i></span>
                    <span class="star filled"><i class="bi bi-star-fill"></i></span>
                    <span class="star filled"><i class="bi bi-star-fill"></i></span>
                    <span class="star filled"><i class="bi bi-star-fill"></i></span>
                  </div>
                </td>
                <td>9/5/2025</td>
                <td><button class="action-btn">View</button></td>
              </tr>
            </tbody>
          </table>
          
          <!-- Pagination Container -->
          <div id="feedbackPagination" class="pagination-container" style="display:none;">
            <!-- Pagination will be rendered here by JavaScript -->
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Feedback View Modal -->
  <div id="feedbackViewModal" class="feedback-view-modal" style="display: none;">
    <div class="feedback-view-backdrop"></div>
    <div class="feedback-view-content">
      <div class="feedback-view-header">
        <h2 class="feedback-view-title">Feedback Details</h2>
        <button class="feedback-view-close">&times;</button>
      </div>
      <div class="feedback-view-body">
        <div id="feedbackViewContent">
          <!-- Feedback details will be loaded here -->
        </div>
      </div>
      <div class="feedback-view-footer">
        <button class="feedback-view-btn feedback-view-btn-close" onclick="closeFeedbackView()">Close</button>
      </div>
    </div>
  </div>
</template>

<script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/jspdf-autotable@latest/dist/jspdf.plugin.autotable.js"></script>
<script src="assets/js/config/error-handler.js"></script>
<script>
  // Fallback for jsPDF if CDN fails
  if (typeof window.jspdf === 'undefined') {
    document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"><\/script>');
    document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"><\/script>');
  }
</script>
<script src="../assets/js/User/sidebarexpand.js"></script>
<script src="../assets/js/User/spa.js"></script>
<script src="../assets/js/User/analyticstat.js"></script>
<script src="../assets/js/User/ad-chart.js"></script>
<script src="../assets/js/User/ad-gauge.js"></script>
<script src="../assets/js/User/sensor-dashboard.js"></script>
<script src="../assets/js/User/food-selection.js"></script>
<script src="../assets/js/User/ml-data-upload.js"></script>
<script src="../assets/js/User/device-management.js"></script>
<script src="../assets/js/User/report-generator.js"></script>
<script src="../assets/js/User/spoilageReport.js"></script>
<script src="../assets/js/User/analysis.js"></script>
<script src="../assets/js/User/user-log.js"></script>
<script src="../assets/js/User/config.js"></script>
<script src="../assets/js/User/feedback.js"></script>
<script src="../assets/js/User/alerts.js"></script>
<script src="../assets/js/User/latest-scan.js"></script>
<script src="../assets/js/User/user-auth.js"></script>
<script>
  // Navigation for dashboard/detailed report is handled globally by spa.js (switchPage).
  // This placeholder avoids duplicate handlers.
  
  // Edit Account Modal Functionality
  function openEditAccountModal() {
    const modal = document.getElementById('editAccountModal');
    if (!modal) return;
    
    // Load current user data
    loadTesterTypes().then(loadUserDataForEdit);
    
    // Show modal
    modal.style.display = 'flex';
    
    // Bind close functionality
    const closeModal = () => {
      modal.style.display = 'none';
    };
    
    const closeBtn = modal.querySelector('.config-modal-close');
    const cancelBtn = modal.querySelector('.config-modal-cancel');
    const backdrop = modal.querySelector('.config-modal-backdrop');
    
    [closeBtn, cancelBtn, backdrop].forEach(btn => {
      if (btn) btn.onclick = closeModal;
    });
    
    // Close on Escape key
    const escHandler = (e) => {
      if (e.key === 'Escape') {
        closeModal();
        document.removeEventListener('keydown', escHandler);
      }
    };
    document.addEventListener('keydown', escHandler);
  }
  
  // Load user data for editing
  async function loadUserDataForEdit() {
    try {
      const sessionToken = localStorage.getItem('jwt_token') || 
                          localStorage.getItem('sessionToken') || 
                          localStorage.getItem('session_token');
      
      if (!sessionToken) {
        console.error('No session token found');
        return;
      }
      
      const response = await fetch('/api/users/profile', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${sessionToken}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const result = await response.json();
      
      if (result.success && result.user) {
        const user = result.user;
        
        // Populate form fields
        document.getElementById('editFirstName').value = user.first_name || '';
        document.getElementById('editLastName').value = user.last_name || '';
        document.getElementById('editUsername').value = user.username || '';
        document.getElementById('editEmail').value = user.email || '';
        document.getElementById('editContactNumber').value = user.contact_number || '';
        
        // Populate tester type display
        const testerText = document.getElementById('editTesterTypeText');
        if (testerText) {
          const id = user.tester_type_id || null;
          const name = (window.__TesterTypeMap && id) ? (window.__TesterTypeMap[id] || 'Unknown') : (user.tester_type_name || 'Not set');
          testerText.textContent = name || 'Not set';
        }
        
        // Update avatar with user initials
        const avatar = document.getElementById('editAccountAvatar');
        if (avatar && user.first_name && user.last_name) {
          const initials = (user.first_name.charAt(0) + user.last_name.charAt(0)).toUpperCase();
          avatar.textContent = initials;
        }
        
        // Clear password fields for security
        document.getElementById('editNewPassword').value = '';
        document.getElementById('editReenterPassword').value = '';
      }
    } catch (error) {
      console.error('Error loading user data:', error);
    }
  }

  // Load tester types from API and build id->name map
  async function loadTesterTypes() {
    try {
      const sessionToken = localStorage.getItem('jwt_token') || 
                          localStorage.getItem('sessionToken') || 
                          localStorage.getItem('session_token');
      if (!sessionToken) {
        console.warn('No session token found for loading tester types');
        return;
      }

      const resp = await fetch('/api/users/tester-types', {
        headers: { 'Authorization': `Bearer ${sessionToken}` }
      });
      
      if (!resp.ok) {
        console.error('Failed to fetch tester types:', resp.status, resp.statusText);
        const text = await resp.text();
        console.error('Response body:', text);
        return;
      }
      
      const json = await resp.json();
      console.log('Tester types loaded:', json);
      window.__TesterTypeMap = {};
      (json.data || []).forEach(t => {
        window.__TesterTypeMap[t.id] = t.name;
      });
    } catch (e) {
      console.error('Failed to load tester types:', e);
      // Fallback: map common IDs to names
      window.__TesterTypeMap = {
        1: 'Personal Tester',
        2: 'Canteen Tester',
        3: 'Restaurant Tester',
        4: 'Cafeteria Tester',
        5: 'Catering Tester'
      };
    }
  }
  
  // Validation helper functions (matching registration style)
  function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  function validatePassword(password) {
    // Same validation as registration: min 6 characters
    return password.length >= 6;
  }

  function validateName(name) {
    return name.trim().length >= 2;
  }

  function validateUsername(username) {
    return /^[a-zA-Z0-9_]{3,30}$/.test(username);
  }

  function validatePhoneNumber(phone) {
    if (!phone || phone.trim() === '') return false; // Required field
    // Remove common formatting characters (spaces, dashes, parentheses, plus signs)
    const cleaned = phone.replace(/[\s\-\(\)\+]/g, '');
    
    // Philippine mobile number patterns only:
    // Mobile: 09XXXXXXXXX (11 digits starting with 09) - most common format
    // Mobile without leading 0: 9XXXXXXXXX (10 digits starting with 9)
    // Mobile with country code: 639XXXXXXXXX (12 digits starting with 639)
    
    // Check for mobile numbers only
    const mobilePattern1 = /^09\d{9}$/; // 09XXXXXXXXX (11 digits) - standard PH mobile format
    const mobilePattern2 = /^9\d{9}$/; // 9XXXXXXXXX (10 digits, without leading 0)
    const mobilePattern3 = /^639\d{9}$/; // 639XXXXXXXXX (12 digits with country code +63)
    
    // Return true if it matches any Philippine mobile pattern
    return mobilePattern1.test(cleaned) || 
           mobilePattern2.test(cleaned) || 
           mobilePattern3.test(cleaned);
  }

  // Error handling functions (matching registration style)
  function showError(input, message) {
    const inputField = input.closest('.config-modal-group');
    if (!inputField) return;
    inputField.classList.add('error');
    
    // Remove existing error message if any
    const existingError = inputField.querySelector('.error-message');
    if (existingError) {
      existingError.remove();
    }
    
    // Add error message
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    inputField.appendChild(errorDiv);
  }

  function clearError(input) {
    const inputField = input.closest('.config-modal-group');
    if (!inputField) return;
    inputField.classList.remove('error');
    
    const errorMessage = inputField.querySelector('.error-message');
    if (errorMessage) {
      errorMessage.remove();
    }
  }

  // Real-time validation (matching registration style)
  const editFirstNameInput = document.getElementById('editFirstName');
  const editLastNameInput = document.getElementById('editLastName');
  const editUsernameInput = document.getElementById('editUsername');
  const editEmailInput = document.getElementById('editEmail');
  const editContactNumberInput = document.getElementById('editContactNumber');
  const editNewPasswordInput = document.getElementById('editNewPassword');
  const editReenterPasswordInput = document.getElementById('editReenterPassword');

  if (editFirstNameInput) {
    editFirstNameInput.addEventListener('blur', function() {
      const name = this.value.trim();
      if (name && !validateName(name)) {
        showError(this, 'First name must be at least 2 characters long');
      } else {
        clearError(this);
      }
    });
  }

  if (editLastNameInput) {
    editLastNameInput.addEventListener('blur', function() {
      const name = this.value.trim();
      if (name && !validateName(name)) {
        showError(this, 'Last name must be at least 2 characters long');
      } else {
        clearError(this);
      }
    });
  }

  if (editUsernameInput) {
    editUsernameInput.addEventListener('blur', function() {
      const username = this.value.trim();
      if (username && !validateUsername(username)) {
        showError(this, 'Username must be 3-30 characters and contain only letters, numbers, and underscores');
      } else {
        clearError(this);
      }
    });
  }

  if (editEmailInput) {
    editEmailInput.addEventListener('blur', function() {
      const email = this.value.trim();
      if (email && !validateEmail(email)) {
        showError(this, 'Please enter a valid email address');
      } else {
        clearError(this);
      }
    });
  }

  if (editContactNumberInput) {
    editContactNumberInput.addEventListener('blur', function() {
      const phone = this.value.trim();
      if (!phone) {
        showError(this, 'Contact number is required');
      } else if (!validatePhoneNumber(phone)) {
        showError(this, 'Please enter a valid phone number (e.g., 09123456789)');
      } else {
        clearError(this);
      }
    });
  }

  if (editNewPasswordInput) {
    editNewPasswordInput.addEventListener('blur', function() {
      const password = this.value;
      if (password && !validatePassword(password)) {
        showError(this, 'Password must be at least 6 characters long');
      } else {
        clearError(this);
      }
    });
  }

  if (editReenterPasswordInput) {
    editReenterPasswordInput.addEventListener('blur', function() {
      const password = editNewPasswordInput ? editNewPasswordInput.value : '';
      const reenterPassword = this.value;
      if (reenterPassword && password !== reenterPassword) {
        showError(this, 'Passwords do not match');
      } else {
        clearError(this);
      }
    });
  }

  // Handle form submission (matching registration style)
  document.getElementById('editAccountForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Clear all previous errors
    if (editFirstNameInput) clearError(editFirstNameInput);
    if (editLastNameInput) clearError(editLastNameInput);
    if (editUsernameInput) clearError(editUsernameInput);
    if (editEmailInput) clearError(editEmailInput);
    if (editContactNumberInput) clearError(editContactNumberInput);
    if (editNewPasswordInput) clearError(editNewPasswordInput);
    if (editReenterPasswordInput) clearError(editReenterPasswordInput);
    
    // Get form values
    const firstName = editFirstNameInput ? editFirstNameInput.value.trim() : '';
    const lastName = editLastNameInput ? editLastNameInput.value.trim() : '';
    const username = editUsernameInput ? editUsernameInput.value.trim() : '';
    const email = editEmailInput ? editEmailInput.value.trim() : '';
    const contactNumber = editContactNumberInput ? editContactNumberInput.value.trim() : '';
    const newPassword = editNewPasswordInput ? editNewPasswordInput.value : '';
    const reenterPassword = editReenterPasswordInput ? editReenterPasswordInput.value : '';
    
    let hasErrors = false;
    
    // Validate First Name
    if (!firstName) {
      if (editFirstNameInput) showError(editFirstNameInput, 'First name is required');
      hasErrors = true;
    } else if (!validateName(firstName)) {
      if (editFirstNameInput) showError(editFirstNameInput, 'First name must be at least 2 characters long');
      hasErrors = true;
    }
    
    // Validate Last Name
    if (!lastName) {
      if (editLastNameInput) showError(editLastNameInput, 'Last name is required');
      hasErrors = true;
    } else if (!validateName(lastName)) {
      if (editLastNameInput) showError(editLastNameInput, 'Last name must be at least 2 characters long');
      hasErrors = true;
    }
    
    // Validate Username
    if (!username) {
      if (editUsernameInput) showError(editUsernameInput, 'Username is required');
      hasErrors = true;
    } else if (!validateUsername(username)) {
      if (editUsernameInput) showError(editUsernameInput, 'Username must be 3-30 characters and contain only letters, numbers, and underscores');
      hasErrors = true;
    }
    
    // Validate Email
    if (!email) {
      if (editEmailInput) showError(editEmailInput, 'Email is required');
      hasErrors = true;
    } else if (!validateEmail(email)) {
      if (editEmailInput) showError(editEmailInput, 'Please enter a valid email address');
      hasErrors = true;
    }
    
    // Validate Contact Number (required)
    if (!contactNumber) {
      if (editContactNumberInput) showError(editContactNumberInput, 'Contact number is required');
      hasErrors = true;
    } else if (!validatePhoneNumber(contactNumber)) {
      if (editContactNumberInput) showError(editContactNumberInput, 'Please enter a valid mobile number (e.g., 09123456789)');
      hasErrors = true;
    }
    
    // Validate Password (optional but must meet requirements if provided)
    if (newPassword) {
      if (!validatePassword(newPassword)) {
        if (editNewPasswordInput) showError(editNewPasswordInput, 'Password must be at least 6 characters long');
        hasErrors = true;
      } else if (newPassword !== reenterPassword) {
        if (editReenterPasswordInput) showError(editReenterPasswordInput, 'Passwords do not match');
        hasErrors = true;
      }
    } else if (reenterPassword) {
      // If re-enter password is provided but new password is not
      if (editNewPasswordInput) showError(editNewPasswordInput, 'Please enter a new password');
      hasErrors = true;
    }
    
    if (hasErrors) {
      return;
    }
    
    const formData = {
      first_name: firstName,
      last_name: lastName,
      username: username,
      email: email,
      contact_number: contactNumber,
      new_password: newPassword || undefined
    };
    
    try {
      const sessionToken = localStorage.getItem('jwt_token') || 
                          localStorage.getItem('sessionToken') || 
                          localStorage.getItem('session_token');
      
      if (!sessionToken) {
        window.modalSystem.error('No session token found. Please log in again.', 'Authentication Error');
        return;
      }
      
      const response = await fetch('/api/users/update-profile', {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${sessionToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      });
      
      const result = await response.json();
      
      if (result.success) {
        if (typeof showSuccessToast === 'function') {
          showSuccessToast('Profile updated successfully!');
        } else {
          // Fallback to modal if toast helper not available
          window.modalSystem.success('Profile updated successfully!', 'Success');
        }
        document.getElementById('editAccountModal').style.display = 'none';
        
        // Keep sidebar showing "Profile" instead of user name
        const accountText = document.getElementById('accountText');
        if (accountText) {
          accountText.textContent = 'Profile';
        }
      } else {
        window.modalSystem.error(`Error updating profile: ${result.error || 'Unknown error'}`, 'Update Failed');
      }
    } catch (error) {
      console.error('Error updating profile:', error);
      window.modalSystem.error('Error updating profile. Please try again.', 'Update Failed');
    }
  });

  // Reusable toast helper (styled like logout toast)
  function showToast(type, message) {
    try {
      // Reuse a single toast element to prevent stacking
      const bg = (type==='success')?'#4caf50':(type==='error')?'#e74c3c':(type==='warning')?'#f39c12':'#3498db';
      if (!window.__toastEl) {
        window.__toastEl = document.createElement('div');
        window.__toastEl.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          color: white;
          padding: 15px 20px;
          border-radius: 8px;
          z-index: 10000;
          font-size: 14px;
          font-weight: 500;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          transition: opacity 150ms ease;
          opacity: 0.95;
        `;
        document.body.appendChild(window.__toastEl);
      }
      window.__toastEl.style.background = bg;
      window.__toastEl.textContent = message || 'Success';
      window.__toastEl.style.display = 'block';
      window.__toastEl.style.opacity = '0.95';

      if (window.__toastTimer) {
        clearTimeout(window.__toastTimer);
      }
      window.__toastTimer = setTimeout(() => {
        try {
          if (window.__toastEl) {
            window.__toastEl.style.opacity = '0';
            setTimeout(() => {
              if (window.__toastEl) window.__toastEl.style.display = 'none';
            }, 160);
          }
        } catch (_) {}
      }, 2000);
    } catch (e) {
      // Silent fallback
      try {
        if (type === 'error') window.modalSystem && window.modalSystem.error(message || '');
        else if (type === 'warning') window.modalSystem && window.modalSystem.warning(message || '');
        else if (type === 'info') window.modalSystem && window.modalSystem.info(message || '');
        else window.modalSystem && window.modalSystem.success(message || '');
      } catch (_) {}
    }
  }

  function showSuccessToast(message) { showToast('success', message); }
  function showInfoToast(message) { showToast('info', message); }
  function showWarningToast(message) { showToast('warning', message); }
  function showErrorToast(message) { showToast('error', message); }
  
  // Password visibility toggle
  function togglePasswordVisibility(inputId) {
    const input = document.getElementById(inputId);
    if (!input) return;
    
    const button = input.parentElement.querySelector('.password-toggle');
    if (!button) return;
    
    const icon = button.querySelector('i');
    if (!icon) return;
    
    if (input.type === 'password') {
      input.type = 'text';
      icon.className = 'bi bi-eye-slash';
    } else {
      input.type = 'password';
      icon.className = 'bi bi-eye';
    }
  }
  
  // Make openEditAccountModal globally available
  window.openEditAccountModal = openEditAccountModal;
  
  // Global Modal System
  class ModalSystem {
    constructor() {
      this.modal = document.getElementById('globalModal');
      this.titleElement = this.modal.querySelector('.modal-title-text');
      this.iconElement = this.modal.querySelector('.modal-icon');
      this.messageElement = this.modal.querySelector('.modal-message');
      this.cancelBtn = this.modal.querySelector('.modal-btn-cancel');
      this.confirmBtn = this.modal.querySelector('.modal-btn-confirm');
      this.setupEventListeners();
    }

    setupEventListeners() {
      const content = this.modal.querySelector('.modal-content');
      // Prevent clicks inside content from closing the modal
      if (content) content.addEventListener('click', (e) => e.stopPropagation());

      // Single global ESC handler
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && this.modal.classList.contains('show')) {
          this.hide();
        }
      });
    }

    show(options = {}) {
      const {
        title = 'Information',
        message = '',
        type = 'info', // info, success, warning, error
        showCancel = false,
        cancelText = 'Cancel',
        confirmText = 'OK',
        onConfirm = null,
        onCancel = null
      } = options;

      // Remove any previous temporary listeners to avoid stacking
      this.teardownTempListeners && this.teardownTempListeners();

      // Set content
      this.titleElement.textContent = title;
      this.messageElement.innerHTML = message;
      this.cancelBtn.textContent = cancelText;
      this.confirmBtn.textContent = confirmText;

      // Set type styling
      this.modal.className = `modal-system show modal-${type}`;
      
      // Set icon based on type
      const icons = {
        info: '<i class="bi bi-info-circle"></i>',
        success: '<i class="bi bi-check-circle"></i>',
        warning: '<i class="bi bi-exclamation-triangle"></i>',
        error: '<i class="bi bi-x-circle"></i>'
      };
      this.iconElement.innerHTML = icons[type] || icons.info;

      // Show/hide cancel button
      this.cancelBtn.style.display = showCancel ? 'flex' : 'none';

      // Store callbacks
      this.onConfirm = onConfirm;
      this.onCancel = onCancel;

      // Attach fresh one-time listeners to avoid multi-click issues
      const backdrop = this.modal.querySelector('.modal-backdrop');
      const closeX = this.modal.querySelector('.modal-close');

      const cancelOnce = () => {
        const cb = this.onCancel; this.hide(); if (typeof cb === 'function') cb();
      };
      const confirmOnce = () => {
        const cb = this.onConfirm; this.hide(); if (typeof cb === 'function') cb();
      };

      backdrop && backdrop.addEventListener('click', cancelOnce, { once: true });
      closeX && closeX.addEventListener('click', cancelOnce, { once: true });
      this.cancelBtn && this.cancelBtn.addEventListener('click', cancelOnce, { once: true });
      this.confirmBtn && this.confirmBtn.addEventListener('click', confirmOnce, { once: true });

      // Keep a teardown to remove any lingering listeners if hide() is called programmatically
      this.teardownTempListeners = () => {
        backdrop && backdrop.removeEventListener('click', cancelOnce);
        closeX && closeX.removeEventListener('click', cancelOnce);
        this.cancelBtn && this.cancelBtn.removeEventListener('click', cancelOnce);
        this.confirmBtn && this.confirmBtn.removeEventListener('click', confirmOnce);
        this.teardownTempListeners = null;
      };

      // Show modal
      this.modal.classList.add('show');
    }

    hide() {
      // Clean temp listeners to avoid stacking
      this.teardownTempListeners && this.teardownTempListeners();
      this.modal.classList.remove('show');
      this.onConfirm = null;
      this.onCancel = null;
    }

    // Convenience methods
    info(message, title = 'Information') {
      this.show({ title, message, type: 'info' });
    }

    success(message, title = 'Success') {
      this.show({ title, message, type: 'success' });
    }

    warning(message, title = 'Warning') {
      this.show({ title, message, type: 'warning' });
    }

    error(message, title = 'Error') {
      this.show({ title, message, type: 'error' });
    }

    confirm(message, title = 'Confirm', onConfirm = null, onCancel = null) {
      this.show({
        title,
        message,
        type: 'warning',
        showCancel: true,
        confirmText: 'Yes',
        cancelText: 'No',
        onConfirm,
        onCancel
      });
    }
  }

  // Initialize modal system
  window.modalSystem = new ModalSystem();

  // Replace global alert function
  window.alert = function(message) {
    window.modalSystem.info(message);
  };

  // Test modal system on page load (remove this in production)
  document.addEventListener('DOMContentLoaded', function() {
    // Test that modal system is working
    console.log('Modal system initialized:', window.modalSystem);
    
    // Test different modal types
    setTimeout(() => {
      // Uncomment the line below to test modals on page load
      // window.modalSystem.success('Modal system is working correctly!', 'Test Success');
    }, 1000);
  });

  // Add confirm function
  window.confirm = function(message) {
    return new Promise((resolve) => {
      window.modalSystem.show({
        title: 'Confirm',
        message,
        type: 'warning',
        showCancel: true,
        confirmText: 'Yes',
        cancelText: 'No',
        onConfirm: () => {
          window.modalSystem.hide();
          resolve(true);
        },
        onCancel: () => {
          window.modalSystem.hide();
          resolve(false);
        }
      });
    });
  };
  
  // Sidebar account section event handling
  document.addEventListener('DOMContentLoaded', function() {
    const sidebarAccount = document.getElementById('sidebarAccount');
    const logoutBtn = document.getElementById('logoutBtn');
    
    // Handle profile click (open edit modal)
    if (sidebarAccount) {
      sidebarAccount.addEventListener('click', function(e) {
        // Only open modal if not clicking on logout button
        if (!e.target.closest('.logout-btn')) {
          e.preventDefault();
          e.stopPropagation();
          openEditAccountModal();
        }
      });
    }
    
    // Handle logout button click
    if (logoutBtn) {
      logoutBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        // Logout functionality is handled in user-auth.js
        console.log('Logout button clicked');
      });
    }

    // Handle view recommendations buttons
    const viewRecommendationsBtns = document.querySelectorAll('.view-recommendations-btn');
    viewRecommendationsBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const foodId = this.getAttribute('data-food-id');
        openRecommendationsModal(foodId);
      });
    });

    // Handle recommendations modal close
    const recommendationsModal = document.getElementById('foodRecommendationsModal');
    const recommendationsCloseBtn = document.getElementById('recommendationsCloseBtn');
    const recommendationsBackdrop = recommendationsModal?.querySelector('.config-modal-backdrop');
    const recommendationsCloseX = recommendationsModal?.querySelector('.config-modal-close');

    [recommendationsCloseBtn, recommendationsBackdrop, recommendationsCloseX].forEach(element => {
      if (element) {
        element.addEventListener('click', function() {
          recommendationsModal.style.display = 'none';
          recommendationsModal.classList.remove('show');
          
          // Re-enable body scroll when modal is closed
          document.body.classList.remove('modal-open');
        });
      }
    });

    // Handle view all results button
    const viewAllResultsBtn = document.getElementById('viewAllResultsBtn');
    if (viewAllResultsBtn) {
      viewAllResultsBtn.addEventListener('click', function() {
        // Navigate to detailed report page
        if (typeof switchPage === 'function') {
          switchPage('detailed-report');
        }
      });
    }
  });

  // Function to open recommendations modal with food data
  function openRecommendationsModal(foodId) {
    const modal = document.getElementById('foodRecommendationsModal');
    if (!modal) return;

    // Sample data - in real app, this would come from API
    const foodData = {
      '1': {
        name: 'Fresh Salmon',
        category: 'Seafood',
        created: 'Created: 12/25/2024',
        status: 'Safe',
        riskScore: 'Risk: 15%',
        recommendations: [
          {
            icon: '<i class="bi bi-thermometer"></i>',
            title: 'Temperature Control',
            text: 'Maintain storage temperature between 0-4¬∞C to prevent bacterial growth and maintain freshness.'
          },
          {
            icon: '<i class="bi bi-clock"></i>',
            title: 'Consumption Timeline',
            text: 'Consume within 3 days for optimal quality and safety. Monitor for any changes in appearance or smell.'
          },
          {
            icon: '<i class="bi bi-droplet"></i>',
            title: 'Humidity Management',
            text: 'Current humidity levels are optimal. Avoid exposure to direct moisture to prevent spoilage.'
          }
        ],
        sensors: [
          { label: 'Temperature', value: '2.1¬∞C', status: 'good', statusText: 'Optimal' },
          { label: 'Humidity', value: '65%', status: 'good', statusText: 'Good' },
          { label: 'Gas Level', value: '12 ppm', status: 'good', statusText: 'Normal' }
        ]
      },
      '2': {
        name: 'Chicken Breast',
        category: 'Meat',
        created: 'Created: 12/24/2024',
        status: 'At Risk',
        riskScore: 'Risk: 45%',
        recommendations: [
          {
            icon: '<i class="bi bi-thermometer"></i>',
            title: 'Temperature Alert',
            text: 'Temperature is too high at 4.8¬∞C. Lower storage temperature immediately to prevent spoilage.'
          },
          {
            icon: '<i class="bi bi-clock"></i>',
            title: 'Immediate Consumption',
            text: 'Consume immediately or cook thoroughly. Do not store for more than 3 hours.'
          },
          {
            icon: '<i class="bi bi-exclamation-triangle"></i>',
            title: 'Safety Warning',
            text: 'High risk of bacterial growth detected. Ensure proper cooking temperature if consuming.'
          }
        ],
        sensors: [
          { label: 'Temperature', value: '4.8¬∞C', status: 'warning', statusText: 'Too High' },
          { label: 'Humidity', value: '72%', status: 'warning', statusText: 'High' },
          { label: 'Gas Level', value: '28 ppm', status: 'warning', statusText: 'Elevated' }
        ]
      },
      '3': {
        name: 'Mixed Vegetables',
        category: 'Vegetables',
        created: 'Created: 12/23/2024',
        status: 'Spoiled',
        riskScore: 'Risk: 85%',
        recommendations: [
          {
            icon: '<i class="bi bi-x-circle"></i>',
            title: 'Discard Immediately',
            text: 'High spoilage detected. Do not consume under any circumstances. Dispose of safely.'
          },
          {
            icon: '<i class="bi bi-brush"></i>',
            title: 'Clean Storage Area',
            text: 'Thoroughly clean the storage area to prevent contamination of other food items.'
          },
          {
            icon: '<i class="bi bi-clipboard"></i>',
            title: 'Review Storage Conditions',
            text: 'Check temperature and humidity settings to prevent future spoilage issues.'
          }
        ],
        sensors: [
          { label: 'Temperature', value: '8.2¬∞C', status: 'danger', statusText: 'Critical' },
          { label: 'Humidity', value: '85%', status: 'danger', statusText: 'Excessive' },
          { label: 'Gas Level', value: '95 ppm', status: 'danger', statusText: 'Dangerous' }
        ]
      }
    };

    const data = foodData[foodId];
    if (!data) return;

    // Update modal content
    document.getElementById('detailFoodName').textContent = data.name;
    document.getElementById('detailCategory').textContent = data.category;
    document.getElementById('detailCreated').textContent = data.created;
    document.getElementById('detailStatusBadge').textContent = data.status;
    document.getElementById('detailRiskScore').textContent = data.riskScore;

    // Update status badge color
    const statusBadge = document.getElementById('detailStatusBadge');
    statusBadge.className = 'detail-status-badge';
    if (data.status === 'Safe') {
      statusBadge.style.background = '#22c55e';
    } else if (data.status === 'At Risk') {
      statusBadge.style.background = '#f59e0b';
    } else if (data.status === 'Spoiled') {
      statusBadge.style.background = '#ef4444';
    }

    // Update recommendations
    const recommendationsList = document.getElementById('recommendationsList');
    recommendationsList.innerHTML = '';
    data.recommendations.forEach(rec => {
      const item = document.createElement('div');
      item.className = 'recommendation-item';
      item.innerHTML = `
        <div class="recommendation-icon">${rec.icon}</div>
        <div class="recommendation-content">
          <div class="recommendation-title">${rec.title}</div>
          <div class="recommendation-text">${rec.text}</div>
        </div>
      `;
      recommendationsList.appendChild(item);
    });

    // Update sensor details
    const sensorGrid = document.getElementById('sensorDetailsGrid');
    sensorGrid.innerHTML = '';
    data.sensors.forEach(sensor => {
      const item = document.createElement('div');
      item.className = 'sensor-detail-item';
      item.innerHTML = `
        <div class="sensor-detail-label">${sensor.label}</div>
        <div class="sensor-detail-value">${sensor.value}</div>
        <div class="sensor-detail-status ${sensor.status}">${sensor.statusText}</div>
      `;
      sensorGrid.appendChild(item);
    });

    // Show modal with proper floating positioning
    modal.style.display = 'flex';
    modal.classList.add('show');
    
    // Prevent body scroll when modal is open
    document.body.classList.add('modal-open');
  }

  // Function to update latest scan result
  function updateLatestScanResult(scanData) {
    const latestScanContent = document.getElementById('latestScanContent');
    if (!latestScanContent || !scanData) return;

    const scanResultCard = latestScanContent.querySelector('.scan-result-card');
    if (!scanResultCard) return;

    // Update food info
    const foodName = scanResultCard.querySelector('.scan-food-name');
    const categoryBadge = scanResultCard.querySelector('.scan-category-badge');
    const createdDate = scanResultCard.querySelector('.scan-created');
    
    if (foodName) foodName.textContent = scanData.name || 'Unknown Food';
    if (categoryBadge) {
      categoryBadge.textContent = scanData.category || 'Unknown';
      categoryBadge.className = `scan-category-badge ${(scanData.category || '').toLowerCase()}`;
    }
    if (createdDate) createdDate.textContent = scanData.created || formatPhilippineDate(new Date());

    // Update status
    const statusBadge = scanResultCard.querySelector('.scan-status-badge');
    const riskScore = scanResultCard.querySelector('.scan-risk-score');
    
    if (statusBadge) {
      statusBadge.textContent = scanData.status || 'Unknown';
      statusBadge.className = `scan-status-badge ${(scanData.status || '').toLowerCase().replace(' ', '-')}`;
    }
    if (riskScore) riskScore.textContent = `Risk: ${scanData.riskScore || '0%'}`;

    // Update sensors
    const sensorItems = scanResultCard.querySelectorAll('.scan-sensor-item');
    if (sensorItems.length >= 3 && scanData.sensors) {
      sensorItems[0].querySelector('.sensor-value').textContent = scanData.sensors.temperature || 'N/A';
      sensorItems[1].querySelector('.sensor-value').textContent = scanData.sensors.humidity || 'N/A';
      sensorItems[2].querySelector('.sensor-value').textContent = scanData.sensors.gas || 'N/A';
    }

    // Update expiry
    const expiryDate = scanResultCard.querySelector('.scan-expiry-date');
    const expiryStatus = scanResultCard.querySelector('.scan-expiry-status');
    
    if (expiryDate) expiryDate.textContent = `Expires: ${scanData.expiryDate || 'N/A'}`;
    if (expiryStatus) {
      expiryStatus.textContent = scanData.expiryStatus || 'Unknown';
      expiryStatus.className = `scan-expiry-status ${(scanData.expiryStatus || '').toLowerCase().replace(' ', '-')}`;
    }

    // Update button data attribute
    const viewBtn = scanResultCard.querySelector('.view-recommendations-btn');
    if (viewBtn) viewBtn.setAttribute('data-food-id', scanData.id || '1');
  }

  // Make updateLatestScanResult globally available
  window.updateLatestScanResult = updateLatestScanResult;

  // Format date to Philippine time
  function formatPhilippineDate(date) {
    if (!date) return new Date().toLocaleDateString('en-PH');
    
    // Convert to Philippine time (UTC+8)
    const phDate = new Date(date);
    const phTime = new Date(phDate.getTime() + (8 * 60 * 60 * 1000)); // Add 8 hours for PH time
    
    return phTime.toLocaleDateString('en-PH', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      timeZone: 'Asia/Manila'
    });
  }

  // Test function for recommendations modal
  window.testRecommendationsModal = function() {
    console.log('üß™ Testing recommendations modal...');
    const modal = document.getElementById('foodRecommendationsModal');
    if (!modal) {
      console.error('‚ùå Modal not found');
      return;
    }
    
    console.log('‚úÖ Modal found, showing...');
    modal.style.display = 'flex';
    modal.classList.add('show');
    document.body.classList.add('modal-open');
    
    // Auto close after 3 seconds for testing
    setTimeout(() => {
      modal.style.display = 'none';
      modal.classList.remove('show');
      document.body.classList.remove('modal-open');
      console.log('‚úÖ Modal test completed');
    }, 3000);
  };

  // Alert functionality
  document.addEventListener('DOMContentLoaded', function() {
    // Handle alert dismiss buttons
    const dismissButtons = document.querySelectorAll('.alert-action-btn.dismiss');
    dismissButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        const alertItem = this.closest('.alert-item');
        if (alertItem) {
          alertItem.style.opacity = '0';
          alertItem.style.transform = 'translateX(-100%)';
          setTimeout(() => {
            alertItem.remove();
            updateAlertsDisplay();
          }, 300);
        }
      });
    });

    // Handle alert action buttons
    const actionButtons = document.querySelectorAll('.alert-action-btn:not(.dismiss)');
    actionButtons.forEach(btn => {
      btn.addEventListener('click', function() {
        const alertTitle = this.closest('.alert-item').querySelector('.alert-title').textContent;
        console.log(`Action clicked for: ${alertTitle}`);
        // Add your alert action logic here
      });
    });
  });

  // Function to update alerts display
  function updateAlertsDisplay() {
    const alertsContainer = document.getElementById('alerts-container');
    const alertItems = alertsContainer.querySelectorAll('.alert-item');
    
    if (alertItems.length === 0) {
      alertsContainer.innerHTML = '<div class="no-alerts">No active alerts</div>';
    }
  }

  // Function to add new alert
  function addAlert(alertData) {
    const alertsContainer = document.getElementById('alerts-container');
    
    // Remove "no alerts" message if it exists
    const noAlerts = alertsContainer.querySelector('.no-alerts');
    if (noAlerts) {
      noAlerts.remove();
    }

    const alertItem = document.createElement('div');
    alertItem.className = `alert-item ${alertData.severity}`;
    alertItem.innerHTML = `
      <div class="alert-icon">
        <i class="bi ${alertData.icon}"></i>
      </div>
      <div class="alert-content">
        <h5 class="alert-title">${alertData.title}</h5>
        <p class="alert-description">${alertData.description}</p>
        <p class="alert-time">${alertData.time}</p>
        <span class="alert-severity ${alertData.severity}">${alertData.severityText}</span>
        <div class="alert-actions">
          <button class="alert-action-btn">View Details</button>
          <button class="alert-action-btn dismiss">Dismiss</button>
        </div>
      </div>
    `;

    // Add event listeners to new alert
    const dismissBtn = alertItem.querySelector('.alert-action-btn.dismiss');
    const actionBtn = alertItem.querySelector('.alert-action-btn:not(.dismiss)');
    
    dismissBtn.addEventListener('click', function() {
      alertItem.style.opacity = '0';
      alertItem.style.transform = 'translateX(-100%)';
      setTimeout(() => {
        alertItem.remove();
        updateAlertsDisplay();
      }, 300);
    });

    actionBtn.addEventListener('click', function() {
      console.log(`Action clicked for: ${alertData.title}`);
    });

    alertsContainer.appendChild(alertItem);
    
    // Add event listeners to the new alert item
    addAlertEventListeners(alertItem);
  }
  
  // Function to add event listeners to alert items
  function addAlertEventListeners(alertItem) {
    // Handle dismiss button
    const dismissBtn = alertItem.querySelector('.alert-action-btn.dismiss');
    if (dismissBtn) {
      dismissBtn.addEventListener('click', function() {
        alertItem.style.opacity = '0';
        alertItem.style.transform = 'translateX(-100%)';
        setTimeout(() => {
          alertItem.remove();
          updateAlertsDisplay();
        }, 300);
      });
    }
    
    // Handle action buttons
    const actionBtn = alertItem.querySelector('.alert-action-btn:not(.dismiss)');
    if (actionBtn) {
      actionBtn.addEventListener('click', function() {
        const alertTitle = alertItem.querySelector('.alert-title').textContent;
        console.log(`Action clicked for: ${alertTitle}`);
        // Add your alert action logic here
      });
    }
  }

  // Make functions globally available
  window.addAlert = addAlert;
  window.updateAlertsDisplay = updateAlertsDisplay;
  window.addAlertEventListeners = addAlertEventListeners;

  // Function to check if text is truncated and add tooltip accordingly
  function checkTextTruncation() {
    const navItems = document.querySelectorAll('.nav-item.is-truncated .nav-text');
    navItems.forEach(navText => {
      const isTruncated = navText.scrollWidth > navText.clientWidth;
      if (isTruncated) {
        navText.setAttribute('data-truncated', 'true');
        navText.setAttribute('data-tooltip', navText.textContent);
      } else {
        navText.removeAttribute('data-truncated');
        navText.removeAttribute('data-tooltip');
      }
    });
  }

  // Check truncation on page load and window resize
  document.addEventListener('DOMContentLoaded', function() {
    checkTextTruncation();
    
    // Initialize feedback system
    initializeFeedbackData();
    
    // Add event listeners for feedback filters
    const feedbackSearch = document.getElementById('feedbackSearch');
    const feedbackTypeFilter = document.getElementById('feedbackTypeFilter');
    const feedbackPriorityFilter = document.getElementById('feedbackPriorityFilter');
    const feedbackStatusFilter = document.getElementById('feedbackStatusFilter');
    const feedbackRecordsPerPage = document.getElementById('feedbackRecordsPerPage');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');
    
    console.log('Setting up feedback event listeners...');
    console.log('Elements found:', {
      feedbackSearch: !!feedbackSearch,
      feedbackTypeFilter: !!feedbackTypeFilter,
      feedbackPriorityFilter: !!feedbackPriorityFilter,
      feedbackStatusFilter: !!feedbackStatusFilter,
      feedbackRecordsPerPage: !!feedbackRecordsPerPage,
      clearFiltersBtn: !!clearFiltersBtn
    });
    
    // Note: Feedback event listeners are now handled in attachFeedbackEventListeners()
    // to prevent SPA conflicts and duplicate event attachments
  });

  // Listen for SPA navigation events
  window.addEventListener('spa:navigate:after', function(event) {
    const page = event.detail.to;
    console.log('SPA navigation to:', page);
    
    if (page === 'feedback' || page === 'feedbacks') {
      console.log('Feedback page loaded via SPA, setting up...');
      // Use a longer delay to ensure DOM is fully ready
      setTimeout(() => {
        if (window.attachFeedbackEventListeners) {
          console.log('SPA: Attaching feedback event listeners...');
          window.attachFeedbackEventListeners();
        }
        // Initialize feedback data
        if (window.initializeFeedbackData) {
          console.log('SPA: Initializing feedback data...');
          window.initializeFeedbackData();
        }
      }, 150);
    }
  });

  window.addEventListener('resize', function() {
    checkTextTruncation();
  });

  // Make function globally available
  window.checkTextTruncation = checkTextTruncation;

  // Feedback Pagination System
  let feedbackCurrentPage = 1;
  let feedbackItemsPerPage = 6;
  let feedbackAllData = [];
  let feedbackFilteredData = [];

  // Feedback data will be loaded from API

  // Initialize feedback data
  function initializeFeedbackData() {
    console.log('Initializing feedback data...');
    
    // Clear existing data to force fresh load
    feedbackAllData = [];
    feedbackFilteredData = [];
    feedbackCurrentPage = 1;
    
    // Show loading state
    showFeedbackLoadingState();
    
    // Load feedback data from API
    loadFeedbackData().then(() => {
      console.log('Feedback data loaded from API');
      hideFeedbackLoadingState();
      updateFeedbackStats();
      renderFeedbackTable();
      renderFeedbackCards();
      renderFeedbackPagination();
    }).catch(error => {
      console.error('Failed to load feedback data:', error);
      hideFeedbackLoadingState();
      // Fallback to empty state
      feedbackAllData = [];
      feedbackFilteredData = [];
      updateFeedbackStats();
      renderFeedbackTable();
      renderFeedbackCards();
      renderFeedbackPagination();
    });
  }

  // Show loading state
  function showFeedbackLoadingState() {
    const tbody = document.getElementById('feedbackTableBody');
    const cardsGrid = document.getElementById('feedbackCardsGrid');
    
    if (tbody) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" style="text-align: center; padding: 40px; color: #bfc9da;">
            <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
              <div style="font-size: 24px; animation: spin 1s linear infinite;">‚è≥</div>
              <div style="font-size: 16px; font-weight: 500;">Loading feedback data...</div>
            </div>
          </td>
        </tr>
      `;
    }
    
    if (cardsGrid) {
      cardsGrid.innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #bfc9da;">
          <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
            <div style="font-size: 24px; animation: spin 1s linear infinite;">‚è≥</div>
            <div style="font-size: 16px; font-weight: 500;">Loading feedback data...</div>
          </div>
        </div>
      `;
    }
  }

  // Hide loading state
  function hideFeedbackLoadingState() {
    // Loading state will be replaced by actual data rendering
  }

  // Load feedback data from API
  async function loadFeedbackData() {
    try {
      // Add cache-busting parameter to ensure fresh data
      const timestamp = new Date().getTime();
      const response = await fetch(`/api/feedbacks/?t=${timestamp}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      console.log('API response:', data);
      console.log('API response structure:', {
        hasSuccess: 'success' in data,
        hasData: 'data' in data,
        dataType: Array.isArray(data.data) ? 'array' : typeof data.data,
        dataLength: Array.isArray(data.data) ? data.data.length : 'not array'
      });
      
      if (data.success && data.data && Array.isArray(data.data)) {
        console.log('Raw API data received:', data.data.length, 'items');
        console.log('Available fields in API response:', Object.keys(data.data[0] || {}));
        
        // Map API data to expected format
        feedbackAllData = data.data.map((item, index) => {
          console.log(`Processing item ${index}:`, item);
          console.log(`Raw admin_notes:`, item.admin_notes);
          console.log(`Raw response_text:`, item.response_text);
          const finalRating = parseInt(item['STAR RATE']) || parseInt(item.star_rating) || parseInt(item.starRating) || parseInt(item.rating) || 0;
          console.log(`Rating data for item ${index}:`, {
            'STAR RATE': item['STAR RATE'],
            'star_rating': item.star_rating,
            'starRating': item.starRating,
            'rating': item.rating,
            'final_rating': finalRating,
            'type_star_rating': typeof item.star_rating,
            'type_final': typeof finalRating,
            'raw_item': item
          });
          console.log(`Available fields:`, Object.keys(item));
          
          // Try multiple field name variations
          const mappedItem = {
            id: item.feedback_id || item.id || item.feedbackId || 0,
            name: item['CUSTOMER NAME'] || item.customer_name || item.customerName || item.name || item.user_name || 'Unknown',
            description: item['FEEDBACK TEXT'] || item.feedback_text || item.feedbackText || item.description || item.message || 'No description',
            type: item['FEEDBACK TYPE'] || item.feedback_type || item.feedbackType || item.type || 'General Feedback',
            priority: item.PRIORITY || item.priority || item.priority_level || 'Low',
            status: item.STATUS || item.status || item.feedback_status || 'Active',
            rating: finalRating,
            date: item.created_at ? formatPhilippineDate(new Date(item.created_at)) : (item.date || item.submission_date ? formatPhilippineDate(new Date(item.date || item.submission_date)) : formatPhilippineDate(new Date())),
            // Admin response fields - try multiple variations
            admin_notes: item.admin_notes || item.adminNotes || item['ADMIN NOTES'] || '',
            response_text: item.response_text || item.responseText || item['RESPONSE TEXT'] || ''
          };
          
          console.log(`Mapped item ${index}:`, mappedItem);
          console.log(`Final admin_notes:`, mappedItem.admin_notes);
          console.log(`Final response_text:`, mappedItem.response_text);
          console.log(`Has admin response:`, !!(mappedItem.admin_notes || mappedItem.response_text));
          return mappedItem;
        });
        
        feedbackFilteredData = [...feedbackAllData];
        console.log('Feedback data loaded:', feedbackAllData.length, 'items');
        console.log('Sample feedback item:', feedbackAllData[0]);
      } else {
        console.error('Invalid API response format:', {
          success: data.success,
          hasData: !!data.data,
          dataIsArray: Array.isArray(data.data),
          dataLength: data.data ? data.data.length : 'no data'
        });
        throw new Error('Invalid API response format');
      }
    } catch (error) {
      console.error('Error loading feedback data:', error);
      // Set empty arrays on error
      feedbackAllData = [];
      feedbackFilteredData = [];
    }
  }

  // Update feedback statistics
  function updateFeedbackStats() {
    const totalFeedback = feedbackAllData.length;
    const activeIssues = feedbackAllData.filter(item => item.status === 'Active' && item.type !== 'General Feedback').length;
    const resolvedIssues = feedbackAllData.filter(item => item.status === 'Resolved').length;
    const averageRating = feedbackAllData.length > 0 
      ? (feedbackAllData.reduce((sum, item) => sum + item.rating, 0) / feedbackAllData.length).toFixed(1)
      : 0;

    // Update the stat cards
    const totalFeedbackEl = document.getElementById('totalFeedback');
    const activeIssuesEl = document.getElementById('activeIssues');
    const resolvedIssuesEl = document.getElementById('resolvedIssues');
    const averageRatingEl = document.getElementById('averageRating');

    if (totalFeedbackEl) totalFeedbackEl.textContent = totalFeedback;
    if (activeIssuesEl) activeIssuesEl.textContent = activeIssues;
    if (resolvedIssuesEl) resolvedIssuesEl.textContent = resolvedIssues;
    if (averageRatingEl) averageRatingEl.textContent = averageRating;
  }

  // Render feedback table
  function renderFeedbackTable() {
    const tbody = document.getElementById('feedbackTableBody');
    if (!tbody) return;

    const startIndex = (feedbackCurrentPage - 1) * feedbackItemsPerPage;
    const endIndex = startIndex + feedbackItemsPerPage;
    const pageData = feedbackFilteredData.slice(startIndex, endIndex);

    if (pageData.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="empty-state">
            <div class="empty-state-content">
              <div class="empty-state-icon"><i class="bi bi-chat"></i></div>
              <div class="empty-state-title">No Feedback Found</div>
              <div class="empty-state-desc">No feedback matches your current filters.</div>
            </div>
          </td>
        </tr>
      `;
      // Hide pagination when no data
      const paginationContainer = document.getElementById('feedbackPagination');
      if (paginationContainer) {
        paginationContainer.style.display = 'none';
      }
      return;
    }

    tbody.innerHTML = pageData.map(item => {
      // Defensive programming - ensure all properties exist
      const safeItem = {
        id: item.id || 0,
        name: item.name || 'Unknown',
        description: item.description || 'No description',
        type: item.type || 'General Feedback',
        priority: item.priority || 'Low',
        status: item.status || 'Active',
        rating: parseInt(item.rating) || 0,
        date: item.date || formatPhilippineDate(new Date())
      };
      
      return `
        <tr>
          <td>
            <div class="customer-info">
              <div class="customer-name">${safeItem.name}</div>
              <div class="customer-desc">${safeItem.description}</div>
            </div>
          </td>
          <td><span class="type-badge">${safeItem.type}</span></td>
          <td><span class="priority-badge priority-${safeItem.priority.toLowerCase()}">${safeItem.priority}</span></td>
          <td><span class="status-badge status-${safeItem.status.toLowerCase()}">${safeItem.status === 'Active' ? '<i class="bi bi-clock"></i>' : '<i class="bi bi-check"></i>'} ${safeItem.status}</span></td>
          <td>
            <div class="rating-stars">
              ${Array.from({length: 5}, (_, i) => 
                `<span class="star ${i < safeItem.rating ? 'filled' : ''}"><i class="bi bi-star${i < safeItem.rating ? '-fill' : ''}"></i></span>`
              ).join('')}
            </div>
            <div style="font-size: 10px; color: #666;">(${safeItem.rating})</div>
          </td>
          <td>${safeItem.date}</td>
          <td><button class="action-btn" onclick="viewFeedback(${safeItem.id})">View</button></td>
        </tr>
      `;
    }).join('');
  }

  // Render feedback cards
  function renderFeedbackCards() {
    const cardsGrid = document.getElementById('feedbackCardsGrid');
    if (!cardsGrid) return;

    const startIndex = (feedbackCurrentPage - 1) * feedbackItemsPerPage;
    const endIndex = startIndex + feedbackItemsPerPage;
    const pageData = feedbackFilteredData.slice(startIndex, endIndex);

    if (pageData.length === 0) {
      cardsGrid.innerHTML = `
        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #bfc9da;">
          <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
            <div style="font-size: 48px; opacity: 0.5;"><i class="bi bi-pencil"></i></div>
            <div style="font-size: 18px; font-weight: 500;">No feedback entries found</div>
            <div style="font-size: 14px; opacity: 0.7;">Try adjusting your search or filter criteria</div>
          </div>
        </div>
      `;
      return;
    }

    cardsGrid.innerHTML = pageData.map(item => {
      // Defensive programming - ensure all properties exist
      const safeItem = {
        id: item.id || 0,
        name: item.name || 'Unknown',
        description: item.description || 'No description',
        type: item.type || 'General Feedback',
        priority: item.priority || 'Low',
        status: item.status || 'Active',
        rating: parseInt(item.rating) || 0,
        date: item.date || formatPhilippineDate(new Date())
      };
      
      return `
        <div class="feedback-card">
          <div class="feedback-card-header">
            <div class="feedback-card-customer">
              <div class="feedback-card-name">${safeItem.name}</div>
              <div class="feedback-card-date">${safeItem.date}</div>
            </div>
            <div class="feedback-card-rating">
              <div class="rating-stars">
                ${Array.from({length: 5}, (_, i) => 
                  `<span class="star ${i < safeItem.rating ? 'filled' : ''}"><i class="bi bi-star${i < safeItem.rating ? '-fill' : ''}"></i></span>`
                ).join('')}
              </div>
            </div>
          </div>
          <div class="feedback-card-body">
            <div class="feedback-card-description">${safeItem.description}</div>
          </div>
          <div class="feedback-card-footer">
            <div class="feedback-card-badges">
              <span class="type-badge">${safeItem.type}</span>
              <span class="priority-badge priority-${safeItem.priority.toLowerCase()}">${safeItem.priority}</span>
              <span class="status-badge status-${safeItem.status.toLowerCase()}">${safeItem.status === 'Active' ? '<i class="bi bi-clock"></i>' : '<i class="bi bi-check"></i>'} ${safeItem.status}</span>
            </div>
            <div class="feedback-card-actions">
              <button class="action-btn" onclick="viewFeedback(${safeItem.id})">View</button>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  // Render feedback pagination
  function renderFeedbackPagination() {
    const tablePaginationContainer = document.getElementById('feedbackPagination');
    const cardsPaginationContainer = document.getElementById('feedbackCardsPagination');
    
    const totalItems = feedbackFilteredData.length;
    const totalPages = Math.ceil(totalItems / feedbackItemsPerPage);

    console.log('Rendering pagination:', {
      totalItems,
      feedbackItemsPerPage,
      totalPages,
      currentPage: feedbackCurrentPage,
      tableContainerFound: !!tablePaginationContainer,
      cardsContainerFound: !!cardsPaginationContainer
    });

    // Hide pagination only if no data
    if (totalItems === 0) {
      console.log('Hiding pagination - no data');
      if (tablePaginationContainer) tablePaginationContainer.style.display = 'none';
      if (cardsPaginationContainer) cardsPaginationContainer.style.display = 'none';
      return;
    }

    // Show pagination when there's data (even if only one page)
    console.log('Showing pagination - data exists');
    if (tablePaginationContainer) tablePaginationContainer.style.display = 'block';
    if (cardsPaginationContainer) cardsPaginationContainer.style.display = 'block';

    const startItem = (feedbackCurrentPage - 1) * feedbackItemsPerPage + 1;
    const endItem = Math.min(feedbackCurrentPage * feedbackItemsPerPage, totalItems);

    let paginationHTML = `
      <div class="pagination-info">
        Showing ${startItem}-${endItem} of ${totalItems} feedback entries | Page ${feedbackCurrentPage} of ${totalPages}
      </div>
    `;

    // Always show pagination controls when there's data
    paginationHTML += `<div class="pagination-controls">`;

    // Previous button
    if (feedbackCurrentPage > 1) {
      paginationHTML += `<button class="pagination-btn" onclick="goToFeedbackPage(${feedbackCurrentPage - 1})">‚Äπ</button>`;
    }

    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, feedbackCurrentPage - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage + 1 < maxVisiblePages) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    if (startPage > 1) {
      paginationHTML += `<button class="pagination-btn" onclick="goToFeedbackPage(1)">1</button>`;
      if (startPage > 2) {
        paginationHTML += `<span class="pagination-ellipsis">...</span>`;
      }
    }

    for (let i = startPage; i <= endPage; i++) {
      if (i === feedbackCurrentPage) {
        paginationHTML += `<span class="pagination-current">${i}</span>`;
      } else {
        paginationHTML += `<button class="pagination-btn" onclick="goToFeedbackPage(${i})">${i}</button>`;
      }
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        paginationHTML += `<span class="pagination-ellipsis">...</span>`;
      }
      paginationHTML += `<button class="pagination-btn" onclick="goToFeedbackPage(${totalPages})">${totalPages}</button>`;
    }

    // Next button
    if (feedbackCurrentPage < totalPages) {
      paginationHTML += `<button class="pagination-btn" onclick="goToFeedbackPage(${feedbackCurrentPage + 1})">‚Ä∫</button>`;
    }

    paginationHTML += `</div>`;

    // Apply pagination to both containers
    if (tablePaginationContainer) {
      tablePaginationContainer.innerHTML = paginationHTML;
    }
    if (cardsPaginationContainer) {
      cardsPaginationContainer.innerHTML = paginationHTML;
    }
  }

  // Go to specific page
  function goToFeedbackPage(page) {
    const totalPages = Math.ceil(feedbackFilteredData.length / feedbackItemsPerPage);
    if (page >= 1 && page <= totalPages) {
      feedbackCurrentPage = page;
      renderFeedbackTable();
      renderFeedbackCards();
      renderFeedbackPagination();
    }
  }

  // Change records per page
  function changeFeedbackRecordsPerPage(newPerPage) {
    console.log('Changing records per page to:', newPerPage);
    feedbackItemsPerPage = parseInt(newPerPage);
    feedbackCurrentPage = 1; // Reset to first page
    console.log('New items per page:', feedbackItemsPerPage);
    renderFeedbackTable();
    renderFeedbackCards();
    renderFeedbackPagination();
  }

  // Apply filters
  function applyFeedbackFilters() {
    const searchTerm = document.getElementById('feedbackSearch')?.value.toLowerCase() || '';
    const typeFilter = document.getElementById('feedbackTypeFilter')?.value || '';
    const priorityFilter = document.getElementById('feedbackPriorityFilter')?.value || '';
    const statusFilter = document.getElementById('feedbackStatusFilter')?.value || '';

    feedbackFilteredData = feedbackAllData.filter(item => {
      const matchesSearch = !searchTerm || 
        item.name.toLowerCase().includes(searchTerm) || 
        item.description.toLowerCase().includes(searchTerm);
      const matchesType = !typeFilter || item.type === typeFilter;
      const matchesPriority = !priorityFilter || item.priority === priorityFilter;
      const matchesStatus = !statusFilter || item.status === statusFilter;

      return matchesSearch && matchesType && matchesPriority && matchesStatus;
    });

    feedbackCurrentPage = 1; // Reset to first page
    renderFeedbackTable();
    renderFeedbackCards();
    renderFeedbackPagination();
  }

  // Clear filters
  function clearFeedbackFilters() {
    document.getElementById('feedbackSearch').value = '';
    document.getElementById('feedbackTypeFilter').value = '';
    document.getElementById('feedbackPriorityFilter').value = '';
    document.getElementById('feedbackStatusFilter').value = '';
    document.getElementById('feedbackRecordsPerPage').value = '6';
    
    feedbackItemsPerPage = 6;
    feedbackCurrentPage = 1;
    feedbackFilteredData = [...feedbackAllData];
    renderFeedbackTable();
    renderFeedbackCards();
    renderFeedbackPagination();
  }

  // Refresh feedback data
  function refreshFeedbackData() {
    console.log('Refreshing feedback data...');
    initializeFeedbackData();
  }

  // View feedback details
  function viewFeedback(feedbackId) {
    console.log('Viewing feedback:', feedbackId);
    
    // Find the feedback item
    const feedbackItem = feedbackAllData.find(item => item.id == feedbackId);
    if (!feedbackItem) {
      console.error('Feedback item not found:', feedbackId);
      return;
    }
    
    // Debug admin response data
    console.log('Admin response data for feedback:', feedbackItem.id);
    console.log('Admin notes:', feedbackItem.admin_notes);
    console.log('Response text:', feedbackItem.response_text);
    console.log('Has admin response:', !!(feedbackItem.admin_notes || feedbackItem.response_text));
    
    // Add friendly message if no admin response exists
    if (!feedbackItem.response_text) {
      feedbackItem.response_text = 'We typically respond to feedback within 24 hours. Thank you for your patience!';
      console.log('Added friendly no-response message');
    }
    
    // Create feedback details HTML
    const feedbackDetailsHTML = `
      <div class="feedback-details">
        <div class="feedback-detail-row">
          <div class="feedback-detail-label">Customer Name:</div>
          <div class="feedback-detail-value">${feedbackItem.name}</div>
        </div>
        <div class="feedback-detail-row">
          <div class="feedback-detail-label">Feedback Type:</div>
          <div class="feedback-detail-value">
            <span class="type-badge">${feedbackItem.type}</span>
          </div>
        </div>
        <div class="feedback-detail-row">
          <div class="feedback-detail-label">Priority:</div>
          <div class="feedback-detail-value">
            <span class="priority-badge priority-${feedbackItem.priority.toLowerCase()}">${feedbackItem.priority}</span>
          </div>
        </div>
        <div class="feedback-detail-row">
          <div class="feedback-detail-label">Status:</div>
          <div class="feedback-detail-value">
            <span class="status-badge status-${feedbackItem.status.toLowerCase()}">${feedbackItem.status === 'Active' ? '<i class="bi bi-clock"></i>' : '<i class="bi bi-check"></i>'} ${feedbackItem.status}</span>
          </div>
        </div>
        <div class="feedback-detail-row">
          <div class="feedback-detail-label">Rating:</div>
          <div class="feedback-detail-value">
            <div class="rating-stars">
              ${Array.from({length: 5}, (_, i) => 
                `<span class="star ${i < feedbackItem.rating ? 'filled' : ''}"><i class="bi bi-star${i < feedbackItem.rating ? '-fill' : ''}"></i></span>`
              ).join('')}
              <span class="rating-text">(${feedbackItem.rating}/5)</span>
            </div>
          </div>
        </div>
        <div class="feedback-detail-row">
          <div class="feedback-detail-label">Date:</div>
          <div class="feedback-detail-value">${feedbackItem.date}</div>
        </div>
        <div class="feedback-detail-row feedback-detail-full">
          <div class="feedback-detail-label">Description:</div>
          <div class="feedback-detail-value feedback-description">${feedbackItem.description}</div>
        </div>
        
        <!-- Admin Response Section -->
        <div class="admin-response-section">
          <div class="feedback-detail-row feedback-detail-full">
            <div class="feedback-detail-label">Admin Response:</div>
            <div class="feedback-detail-value feedback-description">${feedbackItem.response_text}</div>
          </div>
        </div>
      </div>
    `;
    
    // Load content into modal
    const contentDiv = document.getElementById('feedbackViewContent');
    if (contentDiv) {
      contentDiv.innerHTML = feedbackDetailsHTML;
    }
    
    // Show modal
    const modal = document.getElementById('feedbackViewModal');
    if (modal) {
      modal.style.display = 'flex';
    }
  }

  // Close feedback view modal
  function closeFeedbackView() {
    const modal = document.getElementById('feedbackViewModal');
    if (modal) {
      modal.style.display = 'none';
    }
  }

  // Make functions globally available
  window.goToFeedbackPage = goToFeedbackPage;
  window.changeFeedbackRecordsPerPage = changeFeedbackRecordsPerPage;
  window.applyFeedbackFilters = applyFeedbackFilters;
  window.clearFeedbackFilters = clearFeedbackFilters;
  window.initializeFeedbackData = initializeFeedbackData;
  window.refreshFeedbackData = refreshFeedbackData;
  window.viewFeedback = viewFeedback;
  window.closeFeedbackView = closeFeedbackView;
  
  // Test function for debugging
  window.testFeedbackPageFilter = function(value) {
    console.log('Testing page filter with value:', value);
    changeFeedbackRecordsPerPage(value);
  };
  
  // Force render pagination function
  window.forceRenderFeedbackPagination = function() {
    console.log('Force rendering feedback pagination...');
    renderFeedbackPagination();
  };
  
  // Cleanup function to remove all feedback event listeners
  window.cleanupFeedbackEventListeners = function() {
    console.log('Cleaning up feedback event listeners...');
    // Remove all event listeners by cloning elements
    const elementsToClean = [
      '.feedback-tab',
      '.view-toggle-btn', 
      '#feedbackSearch',
      '#feedbackTypeFilter',
      '#feedbackPriorityFilter', 
      '#feedbackStatusFilter',
      '#feedbackRecordsPerPage',
      '#clearFiltersBtn'
    ];
    
    elementsToClean.forEach(selector => {
      const elements = document.querySelectorAll(selector);
      elements.forEach(element => {
        element.replaceWith(element.cloneNode(true));
      });
    });
  };
  
  // Function to re-attach feedback event listeners (for SPA navigation)
  window.attachFeedbackEventListeners = function() {
    console.log('Re-attaching feedback event listeners...');
    
    // Remove existing event listeners to prevent duplicates
    const existingTabButtons = document.querySelectorAll('.feedback-tab');
    existingTabButtons.forEach(button => {
      button.replaceWith(button.cloneNode(true));
    });
    
    const existingViewButtons = document.querySelectorAll('.view-toggle-btn');
    existingViewButtons.forEach(button => {
      button.replaceWith(button.cloneNode(true));
    });
    
    // Add tab switching functionality
    const tabButtons = document.querySelectorAll('.feedback-tab');
    tabButtons.forEach(button => {
      button.addEventListener('click', function() {
        const targetTab = this.getAttribute('data-tab');
        console.log('Switching to tab:', targetTab);
        
        // Remove active class from all tabs and content
        document.querySelectorAll('.feedback-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.feedback-tab-content').forEach(content => content.classList.remove('active'));
        
        // Add active class to clicked tab
        this.classList.add('active');
        
        // Show corresponding content
        if (targetTab === 'submit') {
          document.getElementById('submitTabContent').classList.add('active');
        } else if (targetTab === 'history') {
          document.getElementById('historyTabContent').classList.add('active');
          // Re-render pagination when switching to history tab
          setTimeout(() => {
            console.log('Re-rendering pagination after tab switch...');
            renderFeedbackPagination();
          }, 50);
        }
      });
    });

    // Add view toggle functionality (cards/table)
    const viewToggleButtons = document.querySelectorAll('.view-toggle-btn');
    viewToggleButtons.forEach(button => {
      button.addEventListener('click', function() {
        const targetView = this.getAttribute('data-view');
        console.log('Switching to view:', targetView);
        
        // Remove active class from all view buttons
        document.querySelectorAll('.view-toggle-btn').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        
        // Show/hide containers based on view
        const cardsContainer = document.getElementById('feedbackCardsContainer');
        const tableContainer = document.getElementById('feedbackTableContainer');
        const cardsPagination = document.getElementById('feedbackCardsPagination');
        const tablePagination = document.getElementById('feedbackPagination');
        
        if (targetView === 'cards') {
          if (cardsContainer) cardsContainer.style.display = 'block';
          if (tableContainer) tableContainer.style.display = 'none';
          // Show cards pagination, hide table pagination
          if (cardsPagination) cardsPagination.style.display = 'block';
          if (tablePagination) tablePagination.style.display = 'none';
          // Re-render cards when switching to card view
          setTimeout(() => {
            console.log('Re-rendering cards after view switch...');
            renderFeedbackCards();
          }, 50);
        } else if (targetView === 'table') {
          if (cardsContainer) cardsContainer.style.display = 'none';
          if (tableContainer) tableContainer.style.display = 'block';
          // Show table pagination, hide cards pagination
          if (tablePagination) tablePagination.style.display = 'block';
          if (cardsPagination) cardsPagination.style.display = 'none';
          // Re-render table when switching to table view
          setTimeout(() => {
            console.log('Re-rendering table after view switch...');
            renderFeedbackTable();
          }, 50);
        }
      });
    });
    
    const feedbackSearch = document.getElementById('feedbackSearch');
    const feedbackTypeFilter = document.getElementById('feedbackTypeFilter');
    const feedbackPriorityFilter = document.getElementById('feedbackPriorityFilter');
    const feedbackStatusFilter = document.getElementById('feedbackStatusFilter');
    const feedbackRecordsPerPage = document.getElementById('feedbackRecordsPerPage');
    const clearFiltersBtn = document.getElementById('clearFiltersBtn');
    
    console.log('Elements found on re-attach:', {
      feedbackSearch: !!feedbackSearch,
      feedbackTypeFilter: !!feedbackTypeFilter,
      feedbackPriorityFilter: !!feedbackPriorityFilter,
      feedbackStatusFilter: !!feedbackStatusFilter,
      feedbackRecordsPerPage: !!feedbackRecordsPerPage,
      clearFiltersBtn: !!clearFiltersBtn
    });
    
    if (feedbackSearch) feedbackSearch.addEventListener('input', applyFeedbackFilters);
    if (feedbackTypeFilter) feedbackTypeFilter.addEventListener('change', applyFeedbackFilters);
    if (feedbackPriorityFilter) feedbackPriorityFilter.addEventListener('change', applyFeedbackFilters);
    if (feedbackStatusFilter) feedbackStatusFilter.addEventListener('change', applyFeedbackFilters);
    if (feedbackRecordsPerPage) {
      console.log('Re-attaching records per page event listener');
      feedbackRecordsPerPage.addEventListener('change', function() {
        console.log('Records per page changed to:', this.value);
        changeFeedbackRecordsPerPage(this.value);
      });
    } else {
      console.error('feedbackRecordsPerPage element not found on re-attach');
    }
    if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', clearFeedbackFilters);
    
    // Add feedback view modal event listeners
    const feedbackViewModal = document.getElementById('feedbackViewModal');
    const feedbackViewBackdrop = feedbackViewModal?.querySelector('.feedback-view-backdrop');
    const feedbackViewClose = feedbackViewModal?.querySelector('.feedback-view-close');
    
    if (feedbackViewBackdrop) {
      feedbackViewBackdrop.addEventListener('click', closeFeedbackView);
    }
    
    if (feedbackViewClose) {
      feedbackViewClose.addEventListener('click', closeFeedbackView);
    }
  };
</script>
</body>
</html>

